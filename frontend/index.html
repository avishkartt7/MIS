<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIS System - Chart of Accounts</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            color: #000000;
            font-size: 12px;
            overflow: hidden;
        }

        /* Top Menu Bar */
        .menu-bar {
            background: #f0f0f0;
            border-bottom: 1px solid #d4d4d4;
            padding: 8px 12px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .menu-items {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-item {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 3px;
            transition: background 0.2s;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #e5e5e5;
        }

        .menu-item.active {
            background: #0078d4;
            color: white;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 40px;
            left: 0;
            width: 200px;
            height: calc(100vh - 40px);
            background: #f8f8f8;
            border-right: 1px solid #d4d4d4;
            overflow-y: auto;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            border-bottom: 1px solid #e5e5e5;
        }

        .sidebar-link {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sidebar-link:hover {
            background: #e5e5e5;
        }

        .sidebar-link.active {
            background: #0078d4;
            color: white;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            margin-left: 200px;
            margin-top: 40px;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        /* Toolbar */
        .toolbar {
            background: #f8f8f8;
            border-bottom: 1px solid #d4d4d4;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            min-height: 48px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-input {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
            width: 300px;
            font-size: 12px;
        }

        .search-input:focus {
            outline: 1px solid #0078d4;
            border-color: #0078d4;
        }

        .btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: #e5e5e5;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
            border-color: #005a9e;
        }

        .btn-primary:hover {
            background: #005a9e;
        }

        .btn-success {
            background: #107c10;
            color: white;
            border-color: #0e5d0e;
        }

        .btn-success:hover {
            background: #0e5d0e;
        }

        .select-input {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 12px;
            background: white;
        }

        /* Table Container - Excel-like scrolling */
        .table-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: white;
            border: 1px solid #d4d4d4;
        }

        .table-wrapper {
            width: 100%;
            height: 100%;
            overflow: auto;
            position: relative;
        }

        .excel-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 11px;
            background: white;
            table-layout: fixed;
        }

        /* Fixed Header Styling */
        .excel-table thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .excel-table th {
            background: linear-gradient(180deg, #fff2cc 0%, #ffe699 100%);
            border: 1px solid #d4d4d4;
            border-right: 1px solid #bbb;
            border-bottom: 2px solid #999;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            user-select: none;
            height: 32px;
            vertical-align: middle;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .excel-table th:hover {
            background: linear-gradient(180deg, #ffeb9c 0%, #ffd966 100%);
        }

        .excel-table th:active {
            background: linear-gradient(180deg, #ffd966 0%, #ffcc02 100%);
        }

        /* Column Resize Handle */
        .excel-table th::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
        }

        .excel-table th::after:hover {
            background: #0078d4;
        }

        .excel-table td {
            border: 1px solid #d4d4d4;
            border-right: 1px solid #e1e1e1;
            border-bottom: 1px solid #e1e1e1;
            padding: 6px;
            vertical-align: top;
            background: white;
            height: 26px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .excel-table tbody tr:hover {
            background: #f0f8ff;
        }

        .excel-table tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .excel-table tbody tr:nth-child(even):hover {
            background: #f0f8ff;
        }

        /* Column widths */
        .col-account-no { width: 100px; min-width: 100px; }
        .col-name { width: 250px; min-width: 200px; }
        .col-debit-code { width: 150px; min-width: 120px; }
        .col-credit-code { width: 150px; min-width: 120px; }
        .col-short-name { width: 140px; min-width: 120px; }
        .col-created-by { width: 100px; min-width: 80px; }
        .col-created-on { width: 100px; min-width: 90px; }
        .col-updated-by { width: 100px; min-width: 80px; }
        .col-updated-on { width: 100px; min-width: 90px; }
        .col-actions { width: 90px; min-width: 80px; }

        .account-number {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #0066cc;
        }

        .empty-cell {
            color: #999;
            font-style: italic;
        }

        .btn-edit {
            background: #ff8c00;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            cursor: pointer;
            margin-right: 2px;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            cursor: pointer;
        }

        /* Status Bar */
        .status-bar {
            background: #f0f0f0;
            border-top: 1px solid #d4d4d4;
            padding: 4px 12px;
            font-size: 11px;
            color: #666;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 28px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            width: 500px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(180deg, #fff2cc 0%, #ffe699 100%);
            padding: 12px 16px;
            border-bottom: 1px solid #d4d4d4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 14px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            padding: 4px;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: rgba(0,0,0,0.1);
        }

        .modal-body {
            padding: 16px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 12px;
        }

        .form-control {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 12px;
        }

        .form-control:focus {
            outline: 1px solid #0078d4;
            border-color: #0078d4;
        }

        .form-control[readonly] {
            background-color: #f8f8f8;
            color: #666;
        }

        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid #d4d4d4;
            text-align: right;
            background: #f8f8f8;
        }

        .modal-footer .btn {
            margin-left: 8px;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #dc3545;
        }

        /* Hide sections */
        .section {
            display: none;
            height: 100%;
        }

        .section.active {
            display: flex;
            flex-direction: column;
        }

        /* Dashboard */
        .dashboard {
            padding: 20px;
            background: white;
            height: 100%;
            overflow-y: auto;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: linear-gradient(180deg, #fff2cc 0%, #ffe699 100%);
            border: 1px solid #d4d4d4;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 28px;
            font-weight: 700;
            color: #0078d4;
            margin-bottom: 4px;
        }

        .card-description {
            font-size: 11px;
            color: #666;
        }

        /* Sort indicators */
        .sort-asc::after {
            content: ' ▲';
            color: #0078d4;
        }

        .sort-desc::after {
            content: ' ▼';
            color: #0078d4;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .search-input {
                width: 200px;
            }
            
            .col-name { width: 200px; }
            .col-debit-code { width: 130px; }
            .col-credit-code { width: 130px; }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .toolbar {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .search-input {
                width: 150px;
            }
        }

        /* Scrollbar styling */
        .table-wrapper::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .table-wrapper::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }

        /* File upload styles */
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            margin: 12px 0;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload-area:hover {
            border-color: #0078d4;
        }

        .file-upload-area.dragover {
            border-color: #0078d4;
            background: #f0f8ff;
        }

        .file-info {
            background: #e8f5e8;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #28a745;
            margin-top: 8px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Top Menu Bar -->
    <div class="menu-bar">
        <div class="menu-items">
            <div class="menu-item active" onclick="showSection('dashboard')">File</div>
            <div class="menu-item" onclick="showSection('accounts')">Data</div>
            <div class="menu-item">View</div>
            <div class="menu-item">Tools</div>
            <div class="menu-item">Help</div>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="#" class="sidebar-link active" onclick="showSection('dashboard')">Dashboard</a>
            </li>

            <li class="sidebar-item">
                <a href="general-ledger.html" class="sidebar-link">General Ledger</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link" onclick="showSection('accounts')">Chart of Accounts</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">Transactions</a>
            </li>
            
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">Trial Balance</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">Reports</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">Settings</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section active">
            <div class="dashboard">
                <h2 style="margin-bottom: 20px;">MIS System Dashboard</h2>
                
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="card-title">Total Accounts</div>
                        <div class="card-value" id="totalAccounts">0</div>
                        <div class="card-description">Chart of Accounts</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-title">Complete Accounts</div>
                        <div class="card-value" id="completeAccounts">0</div>
                        <div class="card-description">With full details</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-title">Recent Updates</div>
                        <div class="card-value" id="recentUpdates">0</div>
                        <div class="card-description">Last 7 days</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="showSection('accounts')">Open Chart of Accounts</button>
                    <button class="btn btn-success" onclick="addNewAccount()">Add New Account</button>
                    <button class="btn" onclick="exportData()">Export Data</button>
                </div>
            </div>
        </div>

        <!-- Chart of Accounts Section -->
        <div id="accounts-section" class="section">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search accounts...">
                    <button class="btn" id="clearSearch" style="display: none;" onclick="clearSearch()">Clear</button>
                </div>
                <div class="toolbar-right">
                    <select id="recordsPerPage" class="select-input">
                        <option value="50">50 rows</option>
                        <option value="100">100 rows</option>
                        <option value="200">200 rows</option>
                        <option value="all">All rows</option>
                    </select>
                    <button class="btn" onclick="refreshData()">Refresh</button>
                    <button class="btn" onclick="importData()">Import</button>
                    <button class="btn" onclick="exportData()">Export</button>
                    <button class="btn btn-success" onclick="addNewAccount()">Add New</button>
                </div>
            </div>

            <!-- Table Container -->
            <div class="table-container">
                <div id="loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>Loading data...</div>
                </div>
                
                <div id="error" class="error" style="display: none;">
                    <div>Error loading data. Please try again.</div>
                    <button class="btn" onclick="loadAccounts()">Retry</button>
                </div>

                <div class="table-wrapper">
                    <table class="excel-table" id="accountsTable">
                        <thead>
                            <tr>
                                <th class="col-account-no" onclick="sortTable('pts_account_no')" title="Click to sort">Account No</th>
                                <th class="col-name" onclick="sortTable('name')" title="Click to sort">Name</th>
                                <th class="col-debit-code" onclick="sortTable('acc_type_code_debit')" title="Click to sort">Acc Type Code Debit</th>
                                <th class="col-credit-code" onclick="sortTable('acc_type_code_credit')" title="Click to sort">Acc Type Code Credit</th>
                                <th class="col-short-name" onclick="sortTable('short_name')" title="Click to sort">Short Name</th>
                                <th class="col-created-by" onclick="sortTable('created_by')" title="Click to sort">Created By</th>
                                <th class="col-created-on" onclick="sortTable('created_on')" title="Click to sort">Created On</th>
                                <th class="col-updated-by" onclick="sortTable('updated_by')" title="Click to sort">Updated By</th>
                                <th class="col-updated-on" onclick="sortTable('updated_on')" title="Click to sort">Updated On</th>
                                <th class="col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <span id="recordsInfo">Ready</span>
                <span id="filterInfo" style="display: none;"></span>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add New Account</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="accountForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Account No *</label>
                        <input type="text" id="ptsAccountNo" class="form-control" required maxlength="20">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" id="accountName" class="form-control" required maxlength="500">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Short Name</label>
                        <input type="text" id="shortName" class="form-control" maxlength="150">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Acc Type Code Debit</label>
                        <input type="text" id="debitCode" class="form-control" maxlength="50">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Acc Type Code Credit</label>
                        <input type="text" id="creditCode" class="form-control" maxlength="50">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Import Data from Excel/CSV</div>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select File (Excel or CSV)</label>
                    <div class="file-upload-area" onclick="document.getElementById('importFile').click()">
                        <div>Click here to select file or drag and drop</div>
                        <div style="font-size: 10px; color: #666; margin-top: 4px;">
                            Supported: .xlsx, .xls, .csv (Max 10MB)
                        </div>
                    </div>
                    <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display: none;">
                    <div id="fileInfo" class="file-info">
                        <span id="fileName"></span>
                        <button type="button" onclick="clearFileSelection()" style="background: none; border: none; color: #dc3545; cursor: pointer;">Remove</button>
                    </div>
                </div>
                
                <div style="margin-top: 12px; font-size: 11px; color: #666; line-height: 1.4;">
                    <strong>Required columns:</strong> Account No, Name<br>
                    <strong>Optional columns:</strong> Acc Type Code Debit, Acc Type Code Credit, Short Name<br>
                    <strong>Note:</strong> First row should contain headers. Existing accounts will be updated.
                </div>
                
                <div id="filePreview" style="display: none; margin-top: 12px; padding: 10px; background: #f8f8f8; border: 1px solid #ddd; border-radius: 3px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">File Preview:</div>
                    <div id="previewContent" style="font-size: 11px; font-family: monospace; max-height: 150px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeImportModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="importBtn" onclick="processImport()" disabled>Import Data</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let allAccounts = [];
        let filteredAccounts = [];
        let currentSort = { column: null, direction: 'asc' };
        let searchTimeout = null;
        let importedData = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            showSection('dashboard');
            loadDashboardStats();
            bindEvents();
            setupDragDrop();
        });

        // Bind events
        function bindEvents() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => handleSearch(e.target.value), 300);
            });

            // Records per page
            document.getElementById('recordsPerPage').addEventListener('change', function() {
                renderTable();
            });

            // Form submission
            document.getElementById('accountForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleFormSubmit();
            });

            // File input for import
            document.getElementById('importFile').addEventListener('change', handleFileSelect);

            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal();
                    closeImportModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeImportModal();
                }
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    addNewAccount();
                }
            });
        }

        // Setup drag and drop
        function setupDragDrop() {
            const uploadArea = document.querySelector('.file-upload-area');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    document.getElementById('importFile').files = files;
                    handleFileSelect({ target: { files: files } });
                }
            });
        }

        // Show/hide sections
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Update menu active states
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            // Update sidebar active states
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            if (sectionName === 'dashboard') {
                document.getElementById('dashboard-section').classList.add('active');
                document.querySelector('.menu-item[onclick*="dashboard"]').classList.add('active');
                document.querySelector('.sidebar-link[onclick*="dashboard"]').classList.add('active');
                loadDashboardStats();
            } else if (sectionName === 'accounts') {
                document.getElementById('accounts-section').classList.add('active');
                document.querySelector('.menu-item[onclick*="accounts"]').classList.add('active');
                document.querySelector('.sidebar-link[onclick*="accounts"]').classList.add('active');
                loadAccounts();
            }
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/stats');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('totalAccounts').textContent = result.data.totalAccounts.toLocaleString();
                    document.getElementById('completeAccounts').textContent = result.data.namedAccounts.toLocaleString();
                    document.getElementById('recentUpdates').textContent = result.data.recentAccounts.toLocaleString();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('totalAccounts').textContent = 'Error';
                document.getElementById('completeAccounts').textContent = 'Error';
                document.getElementById('recentUpdates').textContent = 'Error';
            }
        }

        // Load accounts data
        async function loadAccounts() {
            showLoading(true);
            try {
                const response = await fetch('/api/accounts');
                const result = await response.json();
                
                if (result.success) {
                    allAccounts = result.data;
                    filteredAccounts = [...allAccounts];
                    renderTable();
                    showLoading(false);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
                showError(true);
                showLoading(false);
            }
        }

        // Handle search
        function handleSearch(searchTerm) {
            const clearBtn = document.getElementById('clearSearch');
            
            if (!searchTerm.trim()) {
                filteredAccounts = [...allAccounts];
                clearBtn.style.display = 'none';
                hideFilterInfo();
            } else {
                const term = searchTerm.toLowerCase();
                filteredAccounts = allAccounts.filter(account => 
                    account.pts_account_no.toLowerCase().includes(term) ||
                    (account.name && account.name.toLowerCase().includes(term)) ||
                    (account.short_name && account.short_name.toLowerCase().includes(term)) ||
                    (account.acc_type_code_debit && account.acc_type_code_debit.toLowerCase().includes(term)) ||
                    (account.acc_type_code_credit && account.acc_type_code_credit.toLowerCase().includes(term))
                );
                clearBtn.style.display = 'inline-block';
                showFilterInfo(searchTerm);
            }
            
            renderTable();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            handleSearch('');
        }

        // Sort table
        function sortTable(column) {
            // Remove existing sort classes
            document.querySelectorAll('.excel-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Add sort class to current column
            const currentTh = document.querySelector(`th[onclick*="${column}"]`);
            currentTh.classList.add(`sort-${currentSort.direction}`);

            filteredAccounts.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                if (column === 'pts_account_no') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                } else if (column === 'created_on' || column === 'updated_on') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else {
                    aVal = aVal.toString().toLowerCase();
                    bVal = bVal.toString().toLowerCase();
                }

                if (currentSort.direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            renderTable();
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('accountsTableBody');
            const recordsPerPage = document.getElementById('recordsPerPage').value;
            
            let displayAccounts = filteredAccounts;
            if (recordsPerPage !== 'all') {
                displayAccounts = filteredAccounts.slice(0, parseInt(recordsPerPage));
            }

            if (displayAccounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                            No accounts found
                        </td>
                    </tr>
                `;
                updateRecordsInfo();
                return;
            }

            tbody.innerHTML = displayAccounts.map(account => `
                <tr>
                    <td class="account-number" title="${account.pts_account_no}">${account.pts_account_no}</td>
                    <td title="${account.name || 'Not set'}">${account.name || '<span class="empty-cell">Not set</span>'}</td>
                    <td title="${account.acc_type_code_debit || 'Not set'}">${account.acc_type_code_debit || '<span class="empty-cell">Not set</span>'}</td>
                    <td title="${account.acc_type_code_credit || 'Not set'}">${account.acc_type_code_credit || '<span class="empty-cell">Not set</span>'}</td>
                    <td title="${account.short_name || 'Not set'}">${account.short_name || '<span class="empty-cell">Not set</span>'}</td>
                    <td title="${account.created_by || 'N/A'}">${account.created_by || 'N/A'}</td>
                    <td title="${formatDateLong(account.created_on)}">${formatDate(account.created_on)}</td>
                    <td title="${account.updated_by || 'N/A'}">${account.updated_by || 'N/A'}</td>
                    <td title="${formatDateLong(account.updated_on)}">${formatDate(account.updated_on)}</td>
                    <td>
                        <button class="btn-edit" onclick="editAccount('${account.pts_account_no}')" title="Edit Account">Edit</button>
                        <button class="btn-delete" onclick="deleteAccount('${account.pts_account_no}')" title="Delete Account">Del</button>
                    </td>
                </tr>
            `).join('');

            updateRecordsInfo();
        }

        // Update records info
        function updateRecordsInfo() {
            const info = document.getElementById('recordsInfo');
            const total = allAccounts.length;
            const filtered = filteredAccounts.length;
            
            if (filtered === total) {
                info.textContent = `Showing ${filtered.toLocaleString()} records`;
            } else {
                info.textContent = `Showing ${filtered.toLocaleString()} of ${total.toLocaleString()} records`;
            }
        }

        // Show filter info
        function showFilterInfo(searchTerm) {
            const filterInfo = document.getElementById('filterInfo');
            filterInfo.textContent = `Filtered: "${searchTerm}"`;
            filterInfo.style.display = 'inline';
        }

        // Hide filter info
        function hideFilterInfo() {
            document.getElementById('filterInfo').style.display = 'none';
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
            document.querySelector('.table-wrapper').style.display = show ? 'none' : 'block';
        }

        // Show/hide error
        function showError(show) {
            document.getElementById('error').style.display = show ? 'flex' : 'none';
            document.querySelector('.table-wrapper').style.display = show ? 'none' : 'block';
        }

        // Modal functions
        function addNewAccount() {
            showSection('accounts');
            setTimeout(() => {
                document.getElementById('modalTitle').textContent = 'Add New Account';
                document.getElementById('accountForm').reset();
                document.getElementById('ptsAccountNo').readOnly = false;
                document.getElementById('saveBtn').textContent = 'Save';
                document.getElementById('accountModal').style.display = 'block';
                document.getElementById('ptsAccountNo').focus();
            }, 100);
        }

        function editAccount(ptsAccountNo) {
            const account = allAccounts.find(acc => acc.pts_account_no === ptsAccountNo);
            if (account) {
                document.getElementById('modalTitle').textContent = 'Edit Account';
                document.getElementById('ptsAccountNo').value = account.pts_account_no;
                document.getElementById('ptsAccountNo').readOnly = true;
                document.getElementById('accountName').value = account.name || '';
                document.getElementById('shortName').value = account.short_name || '';
                document.getElementById('debitCode').value = account.acc_type_code_debit || '';
                document.getElementById('creditCode').value = account.acc_type_code_credit || '';
                document.getElementById('saveBtn').textContent = 'Update';
                document.getElementById('accountModal').style.display = 'block';
                document.getElementById('accountName').focus();
            }
        }

        function deleteAccount(ptsAccountNo) {
            if (confirm(`Are you sure you want to delete account ${ptsAccountNo}?\n\nThis action cannot be undone.`)) {
                deleteAccountAPI(ptsAccountNo);
            }
        }

        async function deleteAccountAPI(ptsAccountNo) {
            try {
                const response = await fetch(`/api/accounts/${ptsAccountNo}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Account deleted successfully!');
                    loadAccounts();
                    loadDashboardStats();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('Error deleting account. Please try again.');
            }
        }

        function closeModal() {
            document.getElementById('accountModal').style.display = 'none';
            document.getElementById('accountForm').reset();
        }

        // Form submission
        async function handleFormSubmit() {
            const formData = {
                pts_account_no: document.getElementById('ptsAccountNo').value.trim(),
                name: document.getElementById('accountName').value.trim(),
                short_name: document.getElementById('shortName').value.trim(),
                acc_type_code_debit: document.getElementById('debitCode').value.trim(),
                acc_type_code_credit: document.getElementById('creditCode').value.trim()
            };

            if (!formData.pts_account_no || !formData.name) {
                alert('Account No and Name are required');
                return;
            }

            const isEdit = document.getElementById('ptsAccountNo').readOnly;
            const url = isEdit ? `/api/accounts/${formData.pts_account_no}` : '/api/accounts';
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pts_account_no: formData.pts_account_no,
                        name: formData.name,
                        short_name: formData.short_name,
                        acc_type_code_debit: formData.acc_type_code_debit,
                        acc_type_code_credit: formData.acc_type_code_credit,
                        updated_by: 'USER'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(isEdit ? 'Account updated successfully!' : 'Account created successfully!');
                    closeModal();
                    loadAccounts();
                    loadDashboardStats();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error saving account:', error);
                alert('Error saving account: ' + error.message);
            }
        }

        // Import functions
        function importData() {
            document.getElementById('importModal').style.display = 'block';
        }
        

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importFile').value = '';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
            importedData = null;
        }

        function clearFileSelection() {
            document.getElementById('importFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
            importedData = null;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            const importBtn = document.getElementById('importBtn');
            
            if (!file) {
                clearFileSelection();
                return;
            }

            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                clearFileSelection();
                return;
            }

            const fileName = file.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            const isCSV = fileName.endsWith('.csv');

            if (!isExcel && !isCSV) {
                alert('Please select an Excel (.xlsx, .xls) or CSV (.csv) file');
                clearFileSelection();
                return;
            }

            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').style.display = 'flex';

            // Show loading in preview
            document.getElementById('filePreview').style.display = 'block';
            document.getElementById('previewContent').innerHTML = 'Loading file preview...';
            
            // Process file based on type
            if (isExcel) {
                processExcelFile(file);
            } else {
                processCSVFile(file);
            }
        }

        function processExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: '',
                        raw: false
                    });
                    
                    if (jsonData.length < 2) {
                        throw new Error('File must contain at least a header row and one data row');
                    }
                    
                    // Process the data
                    const headers = jsonData[0].map(h => String(h).trim());
                    const rows = jsonData.slice(1).map(row => 
                        row.map(cell => String(cell || '').trim())
                    );
                    
                    importedData = parseImportData(headers, rows);
                    showFilePreview(headers, rows.slice(0, 5), importedData.length);
                    
                    document.getElementById('importBtn').disabled = false;
                    
                } catch (error) {
                    console.error('Excel processing error:', error);
                    alert('Error reading Excel file: ' + error.message);
                    clearFileSelection();
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file');
                clearFileSelection();
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processCSVFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const lines = csvText.trim().split('\n');
                    
                    if (lines.length < 2) {
                        throw new Error('CSV file must contain at least a header row and one data row');
                    }
                    
                    const headers = parseCSVLine(lines[0]);
                    const rows = lines.slice(1).map(line => parseCSVLine(line));
                    
                    importedData = parseImportData(headers, rows);
                    showFilePreview(headers, rows.slice(0, 5), importedData.length);
                    
                    document.getElementById('importBtn').disabled = false;
                    
                } catch (error) {
                    console.error('CSV processing error:', error);
                    alert('Error reading CSV file: ' + error.message);
                    clearFileSelection();
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file');
                clearFileSelection();
            };
            
            reader.readAsText(file);
        }

        function parseImportData(headers, rows) {
            const data = [];
            
            // Find column indices
            const findColumnIndex = (searchTerms) => {
                for (let i = 0; i < headers.length; i++) {
                    const headerStr = String(headers[i]).trim().toLowerCase();
                    for (const term of searchTerms) {
                        if (headerStr === term.toLowerCase() || 
                            headerStr.includes(term.toLowerCase()) ||
                            headerStr.replace(/[^a-z0-9]/g, '').includes(term.toLowerCase().replace(/[^a-z0-9]/g, ''))) {
                            return i;
                        }
                    }
                }
                return -1;
            };
            
            const columnIndices = {
                account_no: findColumnIndex(['account no', 'account_no', 'pts_account_no', 'accountno']),
                name: findColumnIndex(['name', 'account name', 'accountname']),
                debit_code: findColumnIndex(['debit', 'acc_type_code_debit', 'debitcode', 'acc type code debit']),
                credit_code: findColumnIndex(['credit', 'acc_type_code_credit', 'creditcode', 'acc type code credit']),
                short_name: findColumnIndex(['short name', 'short_name', 'shortname']),
                created_by: findColumnIndex(['created by', 'created_by', 'createdby']),
                updated_by: findColumnIndex(['updated by', 'updated_by', 'updatedby'])
            };
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                
                const accountNo = columnIndices.account_no >= 0 ? 
                    String(row[columnIndices.account_no] || '').trim() : '';
                const name = columnIndices.name >= 0 ? 
                    String(row[columnIndices.name] || '').trim() : '';
                
                // Skip if no account number or name
                if (!accountNo || !name) continue;
                
                const account = {
                    pts_account_no: accountNo,
                    name: name,
                    acc_type_code_debit: columnIndices.debit_code >= 0 ? 
                        String(row[columnIndices.debit_code] || '').trim() : '',
                    acc_type_code_credit: columnIndices.credit_code >= 0 ? 
                        String(row[columnIndices.credit_code] || '').trim() : '',
                    short_name: columnIndices.short_name >= 0 ? 
                        String(row[columnIndices.short_name] || '').trim() : '',
                    created_by: columnIndices.created_by >= 0 ? 
                        String(row[columnIndices.created_by] || '').trim() : 'IMPORT',
                    updated_by: columnIndices.updated_by >= 0 ? 
                        String(row[columnIndices.updated_by] || '').trim() : 'IMPORT'
                };
                
                data.push(account);
            }
            
            return data;
        }

        function showFilePreview(headers, rows, validCount) {
            const previewContent = document.getElementById('previewContent');
            
            let preview = `<strong>Headers:</strong> ${headers.join(', ')}<br><br>`;
            preview += `<strong>Sample data:</strong><br>`;
            
            rows.forEach((row, index) => {
                if (row.some(cell => cell)) { // Only show rows with data
                    preview += `Row ${index + 1}: ${row.join(' | ')}<br>`;
                }
            });
            
            preview += `<br><strong>Valid records found: ${validCount}</strong>`;
            
            previewContent.innerHTML = preview;
        }

        async function processImport() {
            if (!importedData || importedData.length === 0) {
                alert('No valid data to import');
                return;
            }

            const confirmMessage = `Import ${importedData.length} accounts?\n\nThis will:\n- Add new accounts\n- Update existing accounts\n- Skip invalid records`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Show loading
                const importBtn = document.getElementById('importBtn');
                importBtn.textContent = 'Importing...';
                importBtn.disabled = true;
                
                const response = await fetch('/api/accounts/bulk-import', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ accounts: importedData })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    let message = `Import completed!\n\n`;
                    message += `✓ ${result.data.successCount} accounts processed\n`;
                    message += `📊 Total processed: ${result.data.totalProcessed}\n`;
                    
                    if (result.data.errorCount > 0) {
                        message += `⚠ ${result.data.errorCount} errors occurred\n`;
                        if (result.data.errors && result.data.errors.length > 0) {
                            message += `\nFirst few errors:\n${result.data.errors.slice(0, 3).join('\n')}`;
                        }
                    }
                    
                    alert(message);
                    closeImportModal();
                    loadAccounts();
                    loadDashboardStats();
                } else {
                    throw new Error(result.message || 'Import failed');
                }
            } catch (error) {
                console.error('Import error:', error);
                alert('Import failed: ' + error.message);
            } finally {
                const importBtn = document.getElementById('importBtn');
                importBtn.textContent = 'Import Data';
                importBtn.disabled = false;
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Export function
        function exportData() {
            if (filteredAccounts.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = [
                'Account No', 'Name', 'Acc Type Code Debit', 'Acc Type Code Credit',
                'Short Name', 'Created By', 'Created On', 'Updated By', 'Updated On'
            ];

            const csvContent = [
                headers.join(','),
                ...filteredAccounts.map(account => [
                    account.pts_account_no,
                    `"${(account.name || '').replace(/"/g, '""')}"`,
                    `"${(account.acc_type_code_debit || '').replace(/"/g, '""')}"`,
                    `"${(account.acc_type_code_credit || '').replace(/"/g, '""')}"`,
                    `"${(account.short_name || '').replace(/"/g, '""')}"`,
                    account.created_by || '',
                    formatDateForExport(account.created_on),
                    account.updated_by || '',
                    formatDateForExport(account.updated_on)
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, `chart_of_accounts_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            alert(`Exported ${filteredAccounts.length} accounts successfully!`);
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Utility functions
        function refreshData() {
            loadAccounts();
            loadDashboardStats();
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit'
            });
        }

        function formatDateLong(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDateForExport(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // Make functions globally available
        window.showSection = showSection;
        window.addNewAccount = addNewAccount;
        window.editAccount = editAccount;
        window.deleteAccount = deleteAccount;
        window.closeModal = closeModal;
        window.importData = importData;
        window.closeImportModal = closeImportModal;
        window.clearFileSelection = clearFileSelection;
        window.processImport = processImport;
        window.exportData = exportData;
        window.refreshData = refreshData;
        window.clearSearch = clearSearch;
        window.sortTable = sortTable;
        window.loadAccounts = loadAccounts;
    </script>
</body>
</html>