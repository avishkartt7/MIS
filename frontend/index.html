<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Ledger - MIS System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            color: #000000;
            font-size: 12px;
            overflow: hidden;
        }

        /* Top Menu Bar */
        .menu-bar {
            background: #f0f0f0;
            border-bottom: 1px solid #d4d4d4;
            padding: 8px 12px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .menu-items {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-item {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 3px;
            transition: background 0.2s;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #e5e5e5;
        }

        .menu-item.active {
            background: #0078d4;
            color: white;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 40px;
            left: 0;
            width: 200px;
            height: calc(100vh - 40px);
            background: #f8f8f8;
            border-right: 1px solid #d4d4d4;
            overflow-y: auto;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            border-bottom: 1px solid #e5e5e5;
        }

        .sidebar-link {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sidebar-link:hover {
            background: #e5e5e5;
        }

        .sidebar-link.active {
            background: #0078d4;
            color: white;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            margin-left: 200px;
            margin-top: 40px;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        /* Toolbar */
        .toolbar {
            background: #f8f8f8;
            border-bottom: 1px solid #d4d4d4;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            min-height: 48px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
            width: 200px;
            font-size: 12px;
        }

        .search-input:focus {
            outline: 1px solid #0078d4;
            border-color: #0078d4;
        }

        .btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: #e5e5e5;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
            border-color: #005a9e;
        }

        .btn-primary:hover {
            background: #005a9e;
        }

        .btn-success {
            background: #107c10;
            color: white;
            border-color: #0e5d0e;
        }

        .btn-success:hover {
            background: #0e5d0e;
        }

        .select-input {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 12px;
            background: white;
        }

        /* Table Container */
        .table-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: white;
            border: 1px solid #d4d4d4;
        }

        .table-wrapper {
            width: 100%;
            height: 100%;
            overflow: auto;
            position: relative;
        }

        .gl-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 11px;
            background: white;
            table-layout: fixed;
            min-width: 2000px;
        }

        .gl-table thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .gl-table th {
            background: linear-gradient(180deg, #fff2cc 0%, #ffe699 100%);
            border: 1px solid #d4d4d4;
            border-right: 1px solid #bbb;
            border-bottom: 2px solid #999;
            padding: 6px 4px;
            text-align: left;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            user-select: none;
            height: 32px;
            vertical-align: middle;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .gl-table th:hover {
            background: linear-gradient(180deg, #ffeb9c 0%, #ffd966 100%);
        }

        .gl-table td {
            border: 1px solid #d4d4d4;
            border-right: 1px solid #e1e1e1;
            border-bottom: 1px solid #e1e1e1;
            padding: 4px;
            vertical-align: top;
            background: white;
            height: 24px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .gl-table tbody tr:hover {
            background: #f0f8ff;
        }

        .gl-table tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .gl-table tbody tr:nth-child(even):hover {
            background: #f0f8ff;
        }

        /* Column widths for all 28 fields */
        .col-id { width: 60px; min-width: 60px; }
        .col-date { width: 90px; min-width: 90px; }
        .col-jv { width: 100px; min-width: 80px; }
        .col-year { width: 60px; min-width: 60px; }
        .col-batch { width: 100px; min-width: 80px; }
        .col-batch-seq { width: 60px; min-width: 50px; }
        .col-type { width: 80px; min-width: 70px; }
        .col-type-seq { width: 60px; min-width: 50px; }
        .col-account { width: 100px; min-width: 80px; }
        .col-auxiliary { width: 100px; min-width: 80px; }
        .col-name { width: 200px; min-width: 150px; }
        .col-cc2 { width: 80px; min-width: 60px; }
        .col-shipment { width: 80px; min-width: 60px; }
        .col-doc-ref { width: 100px; min-width: 80px; }
        .col-doc-date { width: 90px; min-width: 80px; }
        .col-m { width: 50px; min-width: 40px; }
        .col-description { width: 200px; min-width: 150px; }
        .col-dc { width: 40px; min-width: 30px; }
        .col-currency { width: 60px; min-width: 50px; }
        .col-foreign { width: 100px; min-width: 80px; }
        .col-aed { width: 100px; min-width: 80px; }
        .col-usd { width: 100px; min-width: 80px; }
        .col-pending { width: 60px; min-width: 50px; }
        .col-locked { width: 60px; min-width: 50px; }
        .col-created-by { width: 80px; min-width: 70px; }
        .col-created-on { width: 110px; min-width: 100px; }
        .col-updated-by { width: 80px; min-width: 70px; }
        .col-updated-on { width: 110px; min-width: 100px; }
        .col-actions { width: 80px; min-width: 70px; }

        .jv-number {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #0066cc;
        }

        .account-number {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #0066cc;
        }

        .amount {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .amount.debit {
            color: #008000;
        }

        .amount.credit {
            color: #cc0000;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: 500;
        }

        .status-locked {
            background: #f8d7da;
            color: #721c24;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: 500;
        }

        .empty-cell {
            color: #999;
            font-style: italic;
        }

        .btn-edit {
            background: #ff8c00;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            cursor: pointer;
            margin-right: 2px;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            cursor: pointer;
        }

        /* Status Bar */
        .status-bar {
            background: #f0f0f0;
            border-top: 1px solid #d4d4d4;
            padding: 4px 12px;
            font-size: 11px;
            color: #666;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 28px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            width: 90%;
            max-width: 1000px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            max-height: 95vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(180deg, #fff2cc 0%, #ffe699 100%);
            padding: 12px 16px;
            border-bottom: 1px solid #d4d4d4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 14px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            padding: 4px;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: rgba(0,0,0,0.1);
        }

        .modal-body {
            padding: 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 12px;
        }

        .form-control {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 12px;
        }

        .form-control:focus {
            outline: 1px solid #0078d4;
            border-color: #0078d4;
        }

        .form-control[readonly] {
            background-color: #f8f8f8;
            color: #666;
        }

        .form-control.required {
            border-left: 3px solid #dc3545;
        }

        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid #d4d4d4;
            text-align: right;
            background: #f8f8f8;
        }

        .modal-footer .btn {
            margin-left: 8px;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #dc3545;
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 4px 8px;
            border: 1px solid #ccc;
            background: white;
            color: #333;
            border-radius: 2px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #0078d4;
            border-color: #0078d4;
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 11px;
            color: #666;
            margin: 0 8px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .search-input {
                width: 150px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .toolbar-left,
            .toolbar-right {
                justify-content: space-between;
                margin: 2px 0;
            }
            
            .search-input {
                width: 100%;
                max-width: 200px;
            }
        }

        /* Scrollbar styling */
        .table-wrapper::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .table-wrapper::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }

        /* Filter panel */
        .filter-panel {
            background: #f8f8f8;
            border-bottom: 1px solid #d4d4d4;
            padding: 8px 12px;
            display: none;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .filter-panel.active {
            display: flex;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .filter-group input,
        .filter-group select {
            padding: 3px 6px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 11px;
        }

        /* Statistics cards */
        .stats-cards {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            border: 1px solid #d4d4d4;
            border-radius: 4px;
            padding: 12px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #0078d4;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <!-- Top Menu Bar -->
    <div class="menu-bar">
        <div class="menu-items">
            <div class="menu-item" onclick="showSection('dashboard')">File</div>
            <div class="menu-item active" onclick="showSection('general-ledger')">Data</div>
            <div class="menu-item">View</div>
            <div class="menu-item">Tools</div>
            <div class="menu-item">Help</div>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="#" class="sidebar-link" onclick="showSection('dashboard')">Dashboard</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link" onclick="showSection('accounts')">Chart of Accounts</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link active" onclick="showSection('general-ledger')">General Ledger</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">Trial Balance</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">Reports</a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">Settings</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Statistics Cards -->
        <div class="stats-cards" style="padding: 12px;">
            <div class="stat-card">
                <div class="stat-value" id="totalEntries">0</div>
                <div class="stat-label">Total Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingEntries">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lockedEntries">0</div>
                <div class="stat-label">Locked</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recentEntries">0</div>
                <div class="stat-label">This Week</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <input type="text" id="searchInput" class="search-input" placeholder="Search entries...">
                <button class="btn" id="clearSearch" style="display: none;" onclick="clearSearch()">Clear</button>
                <button class="btn" id="filterToggle" onclick="toggleFilters()">Filters</button>
            </div>
            <div class="toolbar-right">
                <select id="recordsPerPage" class="select-input">
                    <option value="25">25 rows</option>
                    <option value="50" selected>50 rows</option>
                    <option value="100">100 rows</option>
                    <option value="200">200 rows</option>
                </select>
                <button class="btn" onclick="refreshData()">Refresh</button>
                <button class="btn" onclick="exportData()">Export</button>
                <button class="btn btn-success" onclick="addNewEntry()">Add Entry</button>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel" id="filterPanel">
            <div class="filter-group">
                <label>Account:</label>
                <select id="filterAccount" class="select-input" onchange="applyFilters()">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div class="filter-group">
                <label>From:</label>
                <input type="date" id="filterDateFrom" onchange="applyFilters()">
            </div>
            <div class="filter-group">
                <label>To:</label>
                <input type="date" id="filterDateTo" onchange="applyFilters()">
            </div>
            <div class="filter-group">
                <label>JV#:</label>
                <input type="text" id="filterJV" placeholder="JV Number" onchange="applyFilters()">
            </div>
            <div class="filter-group">
                <label>Currency:</label>
                <select id="filterCurrency" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="AED">AED</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
            <div class="filter-group">
                <label>D/C:</label>
                <select id="filterDC" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="D">Debit</option>
                    <option value="C">Credit</option>
                </select>
            </div>
            <div class="filter-group">
                <label><input type="checkbox" id="filterPending" onchange="applyFilters()"> Pending Only</label>
            </div>
            <button class="btn" onclick="clearFilters()">Clear All</button>
        </div>

        <!-- Table Container -->
        <div class="table-container">
            <div id="loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div>Loading general ledger...</div>
            </div>
            
            <div id="error" class="error" style="display: none;">
                <div>Error loading data. Please try again.</div>
                <button class="btn" onclick="loadGeneralLedger()">Retry</button>
            </div>

            <div class="table-wrapper">
                <table class="gl-table" id="glTable">
                    <thead>
                        <tr>
                            <th class="col-id" onclick="sortTable('id')" title="Click to sort">ID</th>
                            <th class="col-date" onclick="sortTable('transaction_date')" title="Click to sort">Date</th>
                            <th class="col-jv" onclick="sortTable('jv_number')" title="Click to sort">JV#</th>
                            <th class="col-year" onclick="sortTable('year_period')" title="Click to sort">Year</th>
                            <th class="col-batch" onclick="sortTable('batch_number')" title="Click to sort">Batch</th>
                            <th class="col-batch-seq" onclick="sortTable('batch_sequence')" title="Click to sort">B.Seq</th>
                            <th class="col-type" onclick="sortTable('transaction_type')" title="Click to sort">Type</th>
                            <th class="col-type-seq" onclick="sortTable('type_sequence')" title="Click to sort">T.Seq</th>
                            <th class="col-account" onclick="sortTable('account_number')" title="Click to sort">Account</th>
                            <th class="col-auxiliary" onclick="sortTable('auxiliary_account')" title="Click to sort">Auxiliary</th>
                            <th class="col-name" onclick="sortTable('account_name')" title="Click to sort">Name</th>
                            <th class="col-cc2" onclick="sortTable('cc2')" title="Click to sort">CC2</th>
                            <th class="col-shipment" onclick="sortTable('shipment')" title="Click to sort">Shipment</th>
                            <th class="col-doc-ref" onclick="sortTable('doc_ref')" title="Click to sort">Doc Ref</th>
                            <th class="col-doc-date" onclick="sortTable('doc_date')" title="Click to sort">Doc Date</th>
                            <th class="col-m" onclick="sortTable('m_classification')" title="Click to sort">M</th>
                            <th class="col-description" onclick="sortTable('description')" title="Click to sort">Description</th>
                            <th class="col-dc" onclick="sortTable('debit_credit')" title="Click to sort">D/C</th>
                            <th class="col-currency" onclick="sortTable('currency_code')" title="Click to sort">Currency</th>
                            <th class="col-foreign" onclick="sortTable('foreign_amount')" title="Click to sort">Foreign</th>
                            <th class="col-aed" onclick="sortTable('aed_amount')" title="Click to sort">AED</th>
                            <th class="col-usd" onclick="sortTable('usd_amount')" title="Click to sort">USD</th>
                            <th class="col-pending" onclick="sortTable('is_pending')" title="Click to sort">Pending</th>
                            <th class="col-locked" onclick="sortTable('is_locked')" title="Click to sort">Locked</th>
                            <th class="col-created-by" onclick="sortTable('created_by')" title="Click to sort">Created By</th>
                            <th class="col-created-on" onclick="sortTable('created_on')" title="Click to sort">Created On</th>
                            <th class="col-updated-by" onclick="sortTable('updated_by')" title="Click to sort">Updated By</th>
                            <th class="col-updated-on" onclick="sortTable('updated_on')" title="Click to sort">Updated On</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="glTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div>
                <span id="recordsInfo">Ready</span>
                <span id="filterInfo" style="display: none; margin-left: 16px; color: #0078d4;"></span>
            </div>
            <div class="pagination" id="pagination" style="display: none;">
                <button class="pagination-btn" id="firstBtn" onclick="goToPage(1)">First</button>
                <button class="pagination-btn" id="prevBtn" onclick="goToPage(currentPage - 1)">Previous</button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="pagination-btn" id="nextBtn" onclick="goToPage(currentPage + 1)">Next</button>
                <button class="pagination-btn" id="lastBtn" onclick="goToPage(totalPages)">Last</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Entry Modal -->
    <div id="entryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add New Entry</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="entryForm">
                <div class="modal-body">
                    <div class="form-grid">
                        <!-- Basic Information -->
                        <div class="form-group">
                            <label class="form-label">Transaction Date *</label>
                            <input type="date" id="transactionDate" class="form-control required" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">JV Number *</label>
                            <input type="text" id="jvNumber" class="form-control required" required maxlength="50" placeholder="JV2024-001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Year Period *</label>
                            <input type="number" id="yearPeriod" class="form-control required" required value="2024" min="2000" max="2099">
                        </div>
                        
                        <!-- Batch Information -->
                        <div class="form-group">
                            <label class="form-label">Batch Number</label>
                            <input type="text" id="batchNumber" class="form-control" maxlength="50" placeholder="BATCH-001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Batch Sequence</label>
                            <input type="number" id="batchSequence" class="form-control" min="1" placeholder="1">
                        </div>
                        
                        <!-- Transaction Type -->
                        <div class="form-group">
                            <label class="form-label">Transaction Type</label>
                            <select id="transactionType" class="form-control">
                                <option value="">Select Type</option>
                                <option value="JV">Journal Voucher</option>
                                <option value="AP">Accounts Payable</option>
                                <option value="AR">Accounts Receivable</option>
                                <option value="CASH">Cash Transaction</option>
                                <option value="BANK">Bank Transaction</option>
                                <option value="ADJ">Adjustment</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Type Sequence</label>
                            <input type="number" id="typeSequence" class="form-control" min="1" placeholder="1">
                        </div>
                        
                        <!-- Account Information -->
                        <div class="form-group">
                            <label class="form-label">Account Number *</label>
                            <select id="accountNumber" class="form-control required" required onchange="updateAccountName()">
                                <option value="">Select Account</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Account Name</label>
                            <input type="text" id="accountName" class="form-control" readonly maxlength="500">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Auxiliary Account</label>
                            <input type="text" id="auxiliaryAccount" class="form-control" maxlength="100" placeholder="SUB001">
                        </div>
                        
                        <!-- Additional References -->
                        <div class="form-group">
                            <label class="form-label">Cost Center 2</label>
                            <input type="text" id="cc2" class="form-control" maxlength="50" placeholder="CC001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Shipment</label>
                            <input type="text" id="shipment" class="form-control" maxlength="50" placeholder="SHP001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Document Reference</label>
                            <input type="text" id="docRef" class="form-control" maxlength="100" placeholder="INV-001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Document Date</label>
                            <input type="date" id="docDate" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">M Classification</label>
                            <input type="text" id="mClassification" class="form-control" maxlength="10" placeholder="M1">
                        </div>
                        
                        <!-- Transaction Details -->
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Description</label>
                            <textarea id="description" class="form-control" rows="3" placeholder="Transaction description..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Debit/Credit</label>
                            <select id="debitCredit" class="form-control" onchange="updateAmountColors()">
                                <option value="">Select</option>
                                <option value="D">Debit</option>
                                <option value="C">Credit</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Currency</label>
                            <select id="currencyCode" class="form-control" onchange="updateCurrencyAmounts()">
                                <option value="AED">AED</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                            </select>
                        </div>
                        
                        <!-- Amounts -->
                        <div class="form-group">
                            <label class="form-label">Foreign Amount</label>
                            <input type="number" id="foreignAmount" class="form-control amount" step="0.01" min="0" placeholder="0.00" onchange="calculateAmounts()">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">AED Amount</label>
                            <input type="number" id="aedAmount" class="form-control amount" step="0.01" min="0" placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">USD Amount</label>
                            <input type="number" id="usdAmount" class="form-control amount" step="0.01" min="0" placeholder="0.00">
                        </div>
                        
                        <!-- Status -->
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="isPending"> Pending Approval
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="isLocked"> Locked Entry
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Created/Updated By</label>
                            <input type="text" id="createdBy" class="form-control" maxlength="100" placeholder="USER001" value="USER">
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Entry</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let allEntries = [];
        let currentPage = 1;
        let totalPages = 1;
        let recordsPerPage = 50;
        let currentSort = { column: null, direction: 'asc' };
        let searchTimeout = null;
        let accounts = [];
        
        // Exchange rates (you can make this dynamic)
        const exchangeRates = {
            'USD': 3.675,
            'EUR': 4.1,
            'GBP': 4.65
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadGeneralLedger();
            loadAccounts();
            loadStatistics();
            bindEvents();
            setDefaultDate();
        });

        // Bind events
        function bindEvents() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => handleSearch(e.target.value), 300);
            });

            // Records per page
            document.getElementById('recordsPerPage').addEventListener('change', function() {
                recordsPerPage = parseInt(this.value);
                currentPage = 1;
                loadGeneralLedger();
            });

            // Form submission
            document.getElementById('entryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleFormSubmit();
            });

            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    addNewEntry();
                }
            });
        }

        // Set default date to today
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        }

        // Load general ledger entries
        async function loadGeneralLedger() {
            showLoading(true);
            hideError();

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: recordsPerPage,
                    search: document.getElementById('searchInput').value || '',
                    account: document.getElementById('filterAccount')?.value || '',
                    date_from: document.getElementById('filterDateFrom')?.value || '',
                    date_to: document.getElementById('filterDateTo')?.value || '',
                    jv_number: document.getElementById('filterJV')?.value || '',
                    currency: document.getElementById('filterCurrency')?.value || '',
                    debit_credit: document.getElementById('filterDC')?.value || '',
                    pending_only: document.getElementById('filterPending')?.checked || ''
                });

                const response = await fetch(`/api/general-ledger?${params}`);
                const result = await response.json();

                if (result.success) {
                    allEntries = result.data;
                    totalPages = result.pagination.totalPages;
                    currentPage = result.pagination.currentPage;
                    renderTable();
                    updatePagination();
                    showLoading(false);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error loading general ledger:', error);
                showError();
                showLoading(false);
            }
        }

        // Load accounts for dropdown
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const result = await response.json();
                
                if (result.success) {
                    accounts = result.data;
                    populateAccountDropdowns();
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        // Populate account dropdowns
        function populateAccountDropdowns() {
            const accountSelect = document.getElementById('accountNumber');
            const filterSelect = document.getElementById('filterAccount');
            
            // Clear existing options
            accountSelect.innerHTML = '<option value="">Select Account</option>';
            filterSelect.innerHTML = '<option value="">All Accounts</option>';
            
            accounts.forEach(account => {
                const option1 = new Option(`${account.pts_account_no} - ${account.name || 'Unnamed'}`, account.pts_account_no);
                const option2 = new Option(`${account.pts_account_no} - ${account.name || 'Unnamed'}`, account.pts_account_no);
                
                accountSelect.appendChild(option1);
                filterSelect.appendChild(option2);
            });
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/api/general-ledger/stats');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('totalEntries').textContent = stats.totalEntries.toLocaleString();
                    document.getElementById('pendingEntries').textContent = stats.pendingEntries.toLocaleString();
                    document.getElementById('lockedEntries').textContent = stats.lockedEntries.toLocaleString();
                    document.getElementById('recentEntries').textContent = stats.recentEntries.toLocaleString();
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('glTableBody');
            const table = document.getElementById('glTable');

            if (allEntries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="29" style="text-align: center; padding: 40px; color: #666;">
                            No general ledger entries found
                            <div style="margin-top: 12px;">
                                <button class="btn btn-primary" onclick="addNewEntry()">Add First Entry</button>
                            </div>
                        </td>
                    </tr>
                `;
                table.style.display = 'table';
                updateRecordsInfo();
                return;
            }

            tbody.innerHTML = allEntries.map(entry => `
                <tr>
                    <td title="${entry.id}">${entry.id}</td>
                    <td title="${formatDate(entry.transaction_date)}">${formatDate(entry.transaction_date)}</td>
                    <td class="jv-number" title="${entry.jv_number}">${entry.jv_number}</td>
                    <td title="${entry.year_period}">${entry.year_period}</td>
                    <td title="${entry.batch_number || 'Not set'}">${entry.batch_number || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.batch_sequence || 'Not set'}">${entry.batch_sequence || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.transaction_type || 'Not set'}">${entry.transaction_type || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.type_sequence || 'Not set'}">${entry.type_sequence || '<span class="empty-cell">-</span>'}</td>
                    <td class="account-number" title="${entry.account_number}">${entry.account_number}</td>
                    <td title="${entry.auxiliary_account || 'Not set'}">${entry.auxiliary_account || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.account_name || 'Not set'}">${entry.account_name || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.cc2 || 'Not set'}">${entry.cc2 || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.shipment || 'Not set'}">${entry.shipment || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.doc_ref || 'Not set'}">${entry.doc_ref || '<span class="empty-cell">-</span>'}</td>
                    <td title="${formatDate(entry.doc_date) || 'Not set'}">${formatDate(entry.doc_date) || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.m_classification || 'Not set'}">${entry.m_classification || '<span class="empty-cell">-</span>'}</td>
                    <td title="${entry.description || 'Not set'}">${truncateText(entry.description, 30) || '<span class="empty-cell">-</span>'}</td>
                    <td title="${getDebitCreditText(entry.debit_credit)}" style="text-align: center; font-weight: bold; color: ${entry.debit_credit === 'D' ? '#008000' : '#cc0000'}">${entry.debit_credit || '-'}</td>
                    <td title="${entry.currency_code}">${entry.currency_code}</td>
                    <td class="amount" title="${formatAmount(entry.foreign_amount)}">${formatAmount(entry.foreign_amount)}</td>
                    <td class="amount ${entry.debit_credit === 'D' ? 'debit' : 'credit'}" title="${formatAmount(entry.aed_amount)}">${formatAmount(entry.aed_amount)}</td>
                    <td class="amount ${entry.debit_credit === 'D' ? 'debit' : 'credit'}" title="${formatAmount(entry.usd_amount)}">${formatAmount(entry.usd_amount)}</td>
                    <td title="${entry.is_pending ? 'Yes' : 'No'}" style="text-align: center;">${entry.is_pending ? '<span class="status-pending">PENDING</span>' : '-'}</td>
                    <td title="${entry.is_locked ? 'Yes' : 'No'}" style="text-align: center;">${entry.is_locked ? '<span class="status-locked">LOCKED</span>' : '-'}</td>
                    <td title="${entry.created_by || 'N/A'}">${entry.created_by || 'N/A'}</td>
                    <td title="${formatDateTime(entry.created_on)}">${formatDate(entry.created_on)}</td>
                    <td title="${entry.updated_by || 'N/A'}">${entry.updated_by || 'N/A'}</td>
                    <td title="${formatDateTime(entry.updated_on)}">${formatDate(entry.updated_on)}</td>
                    <td style="text-align: center;">
                        <button class="btn-edit" onclick="editEntry(${entry.id})" title="Edit Entry" ${entry.is_locked ? 'disabled' : ''}>Edit</button>
                        <button class="btn-delete" onclick="deleteEntry(${entry.id})" title="Delete Entry" ${entry.is_locked ? 'disabled' : ''}>Del</button>
                    </td>
                </tr>
            `).join('');

            table.style.display = 'table';
            updateRecordsInfo();
        }

        // Update records info
        function updateRecordsInfo() {
            const recordsInfo = document.getElementById('recordsInfo');
            const totalRecords = allEntries.length;
            
            if (currentPage > 1 || totalPages > 1) {
                recordsInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalRecords.toLocaleString()} records)`;
            } else {
                recordsInfo.textContent = `${totalRecords.toLocaleString()} records`;
            }
        }

        // Update pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            document.getElementById('firstBtn').disabled = currentPage === 1;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
            document.getElementById('lastBtn').disabled = currentPage === totalPages;
            
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        }

        // Go to page
        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                loadGeneralLedger();
            }
        }

        // Sort table
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Add visual indicators
            document.querySelectorAll('.gl-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const currentTh = document.querySelector(`th[onclick*="${column}"]`);
            currentTh.classList.add(`sort-${currentSort.direction}`);
            
            loadGeneralLedger(); // Reload with sorting
        }

        // Handle search
        function handleSearch(searchTerm) {
            const clearBtn = document.getElementById('clearSearch');
            
            if (searchTerm.trim()) {
                clearBtn.style.display = 'inline-block';
                showFilterInfo(`Search: "${searchTerm}"`);
            } else {
                clearBtn.style.display = 'none';
                hideFilterInfo();
            }
            
            currentPage = 1;
            loadGeneralLedger();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            handleSearch('');
        }

        // Toggle filters
        function toggleFilters() {
            const filterPanel = document.getElementById('filterPanel');
            const filterToggle = document.getElementById('filterToggle');
            
            if (filterPanel.classList.contains('active')) {
                filterPanel.classList.remove('active');
                filterToggle.textContent = 'Filters';
            } else {
                filterPanel.classList.add('active');
                filterToggle.textContent = 'Hide Filters';
            }
        }

        // Apply filters
        function applyFilters() {
            currentPage = 1;
            loadGeneralLedger();
            
            // Show filter info
            const activeFilters = [];
            if (document.getElementById('filterAccount').value) activeFilters.push('Account');
            if (document.getElementById('filterDateFrom').value) activeFilters.push('Date From');
            if (document.getElementById('filterDateTo').value) activeFilters.push('Date To');
            if (document.getElementById('filterJV').value) activeFilters.push('JV#');
            if (document.getElementById('filterCurrency').value) activeFilters.push('Currency');
            if (document.getElementById('filterDC').value) activeFilters.push('D/C');
            if (document.getElementById('filterPending').checked) activeFilters.push('Pending');
            
            if (activeFilters.length > 0) {
                showFilterInfo(`Filters: ${activeFilters.join(', ')}`);
            } else {
                hideFilterInfo();
            }
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filterAccount').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterJV').value = '';
            document.getElementById('filterCurrency').value = '';
            document.getElementById('filterDC').value = '';
            document.getElementById('filterPending').checked = false;
            
            applyFilters();
        }

        // Show filter info
        function showFilterInfo(text) {
            const filterInfo = document.getElementById('filterInfo');
            filterInfo.textContent = text;
            filterInfo.style.display = 'inline';
        }

        // Hide filter info
        function hideFilterInfo() {
            document.getElementById('filterInfo').style.display = 'none';
        }

        // Modal functions
        function addNewEntry() {
            document.getElementById('modalTitle').textContent = 'Add New General Ledger Entry';
            document.getElementById('entryForm').reset();
            setDefaultDate();
            document.getElementById('currencyCode').value = 'AED';
            document.getElementById('createdBy').value = 'USER';
            document.getElementById('saveBtn').textContent = 'Save Entry';
            document.getElementById('entryModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function editEntry(id) {
            const entry = allEntries.find(e => e.id === id);
            if (entry) {
                document.getElementById('modalTitle').textContent = 'Edit General Ledger Entry';
                fillForm(entry);
                document.getElementById('saveBtn').textContent = 'Update Entry';
                document.getElementById('entryModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function fillForm(entry) {
            document.getElementById('transactionDate').value = entry.transaction_date || '';
            document.getElementById('jvNumber').value = entry.jv_number || '';
            document.getElementById('yearPeriod').value = entry.year_period || '';
            document.getElementById('batchNumber').value = entry.batch_number || '';
            document.getElementById('batchSequence').value = entry.batch_sequence || '';
            document.getElementById('transactionType').value = entry.transaction_type || '';
            document.getElementById('typeSequence').value = entry.type_sequence || '';
            document.getElementById('accountNumber').value = entry.account_number || '';
            document.getElementById('accountName').value = entry.account_name || '';
            document.getElementById('auxiliaryAccount').value = entry.auxiliary_account || '';
            document.getElementById('cc2').value = entry.cc2 || '';
            document.getElementById('shipment').value = entry.shipment || '';
            document.getElementById('docRef').value = entry.doc_ref || '';
            document.getElementById('docDate').value = entry.doc_date || '';
            document.getElementById('mClassification').value = entry.m_classification || '';
            document.getElementById('description').value = entry.description || '';
            document.getElementById('debitCredit').value = entry.debit_credit || '';
            document.getElementById('currencyCode').value = entry.currency_code || '';
            document.getElementById('foreignAmount').value = entry.foreign_amount || '';
            document.getElementById('aedAmount').value = entry.aed_amount || '';
            document.getElementById('usdAmount').value = entry.usd_amount || '';
            document.getElementById('isPending').checked = entry.is_pending || false;
            document.getElementById('isLocked').checked = entry.is_locked || false;
            document.getElementById('createdBy').value = entry.updated_by || 'USER';
        }

        function closeModal() {
            document.getElementById('entryModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('entryForm').reset();
        }

        // Update account name when account is selected
        function updateAccountName() {
            const accountSelect = document.getElementById('accountNumber');
            const accountNameInput = document.getElementById('accountName');
            const selectedAccount = accounts.find(acc => acc.pts_account_no === accountSelect.value);
            
            if (selectedAccount) {
                accountNameInput.value = selectedAccount.name || '';
            } else {
                accountNameInput.value = '';
            }
        }

        // Calculate amounts based on exchange rates
        function calculateAmounts() {
            const currency = document.getElementById('currencyCode').value;
            const foreignAmount = parseFloat(document.getElementById('foreignAmount').value) || 0;
            
            if (currency === 'AED') {
                document.getElementById('aedAmount').value = foreignAmount.toFixed(2);
                document.getElementById('usdAmount').value = (foreignAmount / exchangeRates.USD).toFixed(2);
            } else if (currency === 'USD') {
                document.getElementById('usdAmount').value = foreignAmount.toFixed(2);
                document.getElementById('aedAmount').value = (foreignAmount * exchangeRates.USD).toFixed(2);
            } else {
                const rate = exchangeRates[currency] || 1;
                document.getElementById('aedAmount').value = (foreignAmount * rate).toFixed(2);
                document.getElementById('usdAmount').value = (foreignAmount * rate / exchangeRates.USD).toFixed(2);
            }
        }

        // Update currency amounts when currency changes
        function updateCurrencyAmounts() {
            calculateAmounts();
        }

        // Update amount colors when debit/credit changes
        function updateAmountColors() {
            const dcValue = document.getElementById('debitCredit').value;
            const amountInputs = document.querySelectorAll('.form-control.amount');
            
            amountInputs.forEach(input => {
                input.classList.remove('debit', 'credit');
                if (dcValue === 'D') {
                    input.classList.add('debit');
                } else if (dcValue === 'C') {
                    input.classList.add('credit');
                }
            });
        }

        // Form submission
        async function handleFormSubmit() {
            const formData = getFormData();
            
            if (!validateForm(formData)) {
                return;
            }
            
            const isEdit = document.getElementById('modalTitle').textContent.includes('Edit');
            const entryId = isEdit ? getEditingEntryId() : null;
            
            try {
                const url = isEdit ? `/api/general-ledger/${entryId}` : '/api/general-ledger';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(isEdit ? 'Entry updated successfully!' : 'Entry created successfully!');
                    closeModal();
                    loadGeneralLedger();
                    loadStatistics();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error saving entry:', error);
                alert('Error saving entry: ' + error.message);
            }
        }

        // Get form data
        function getFormData() {
            return {
                transaction_date: document.getElementById('transactionDate').value,
                jv_number: document.getElementById('jvNumber').value,
                year_period: parseInt(document.getElementById('yearPeriod').value),
                batch_number: document.getElementById('batchNumber').value || null,
                batch_sequence: parseInt(document.getElementById('batchSequence').value) || null,
                transaction_type: document.getElementById('transactionType').value || null,
                type_sequence: parseInt(document.getElementById('typeSequence').value) || null,
                account_number: document.getElementById('accountNumber').value,
                auxiliary_account: document.getElementById('auxiliaryAccount').value || null,
                account_name: document.getElementById('accountName').value || null,
                cc2: document.getElementById('cc2').value || null,
                shipment: document.getElementById('shipment').value || null,
                doc_ref: document.getElementById('docRef').value || null,
                doc_date: document.getElementById('docDate').value || null,
                m_classification: document.getElementById('mClassification').value || null,
                description: document.getElementById('description').value || null,
                debit_credit: document.getElementById('debitCredit').value || null,
                currency_code: document.getElementById('currencyCode').value,
                foreign_amount: parseFloat(document.getElementById('foreignAmount').value) || null,
                aed_amount: parseFloat(document.getElementById('aedAmount').value) || null,
                usd_amount: parseFloat(document.getElementById('usdAmount').value) || null,
                is_pending: document.getElementById('isPending').checked,
                is_locked: document.getElementById('isLocked').checked,
                created_by: document.getElementById('createdBy').value || 'USER'
            };
        }

        // Validate form
        function validateForm(formData) {
            if (!formData.transaction_date) {
                alert('Transaction date is required');
                return false;
            }
            
            if (!formData.jv_number) {
                alert('JV number is required');
                return false;
            }
            
            if (!formData.year_period) {
                alert('Year period is required');
                return false;
            }
            
            if (!formData.account_number) {
                alert('Account number is required');
                return false;
            }
            
            return true;
        }

        // Get editing entry ID (helper function)
        function getEditingEntryId() {
            // This would need to be set when opening the edit modal
            // For now, we'll find it based on the JV number
            const jvNumber = document.getElementById('jvNumber').value;
            const entry = allEntries.find(e => e.jv_number === jvNumber);
            return entry ? entry.id : null;
        }

        // Delete entry
        async function deleteEntry(id) {
            const entry = allEntries.find(e => e.id === id);
            if (!entry) return;
            
            if (entry.is_locked) {
                alert('Cannot delete locked entry');
                return;
            }
            
            if (confirm(`Are you sure you want to delete entry ${entry.jv_number}?\n\nThis action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/general-ledger/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Entry deleted successfully!');
                        loadGeneralLedger();
                        loadStatistics();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Error deleting entry:', error);
                    alert('Error deleting entry: ' + error.message);
                }
            }
        }

        // Export data
        function exportData() {
            if (allEntries.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = [
                'ID', 'Date', 'JV#', 'Year', 'Batch', 'Batch Seq', 'Type', 'Type Seq',
                'Account', 'Auxiliary', 'Name', 'CC2', 'Shipment', 'Doc Ref', 'Doc Date',
                'M', 'Description', 'D/C', 'Currency', 'Foreign', 'AED', 'USD',
                'Pending', 'Locked', 'Created By', 'Created On', 'Updated By', 'Updated On'
            ];
            
            const csvContent = [
                headers.join(','),
                ...allEntries.map(entry => [
                    entry.id,
                    entry.transaction_date,
                    `"${entry.jv_number}"`,
                    entry.year_period,
                    `"${entry.batch_number || ''}"`,
                    entry.batch_sequence || '',
                    `"${entry.transaction_type || ''}"`,
                    entry.type_sequence || '',
                    entry.account_number,
                    `"${entry.auxiliary_account || ''}"`,
                    `"${(entry.account_name || '').replace(/"/g, '""')}"`,
                    `"${entry.cc2 || ''}"`,
                    `"${entry.shipment || ''}"`,
                    `"${entry.doc_ref || ''}"`,
                    entry.doc_date || '',
                    `"${entry.m_classification || ''}"`,
                    `"${(entry.description || '').replace(/"/g, '""')}"`,
                    entry.debit_credit || '',
                    entry.currency_code,
                    entry.foreign_amount || '',
                    entry.aed_amount || '',
                    entry.usd_amount || '',
                    entry.is_pending ? 'Yes' : 'No',
                    entry.is_locked ? 'Yes' : 'No',
                    entry.created_by || '',
                    entry.created_on || '',
                    entry.updated_by || '',
                    entry.updated_on || ''
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, `general_ledger_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            alert(`Exported ${allEntries.length} entries successfully!`);
        }

        // Download file
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Utility functions
        function refreshData() {
            loadGeneralLedger();
            loadStatistics();
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
            document.querySelector('.table-wrapper').style.display = show ? 'none' : 'block';
        }

        function showError() {
            document.getElementById('error').style.display = 'flex';
            document.querySelector('.table-wrapper').style.display = 'none';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit'
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatAmount(amount) {
            if (!amount && amount !== 0) return '';
            return parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function getDebitCreditText(dc) {
            if (dc === 'D') return 'Debit';
            if (dc === 'C') return 'Credit';
            return '';
        }

        // Global functions for onclick handlers
        window.showSection = function(section) {
            // This would integrate with your main navigation system
            console.log('Navigate to:', section);
        };

        window.addNewEntry = addNewEntry;
        window.editEntry = editEntry;
        window.deleteEntry = deleteEntry;
        window.closeModal = closeModal;
        window.refreshData = refreshData;
        window.exportData = exportData;
        window.clearSearch = clearSearch;
        window.toggleFilters = toggleFilters;
        window.applyFilters = applyFilters;
        window.clearFilters = clearFilters;
        window.sortTable = sortTable;
        window.goToPage = goToPage;
        window.loadGeneralLedger = loadGeneralLedger;
        window.updateAccountName = updateAccountName;
        window.calculateAmounts = calculateAmounts;
        window.updateCurrencyAmounts = updateCurrencyAmounts;
        window.updateAmountColors = updateAmountColors;
    </script>
</body>
</html>