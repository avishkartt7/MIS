<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIS System - Profit & Loss Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* =====================================================
           COMPLETE P&L REPORT STYLES - PROFESSIONAL DESIGN
           ===================================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
            line-height: 1.4;
            overflow-x: auto;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 28px;
            color: #f39c12;
        }

        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
            transform: translateY(-1px);
        }

        /* Main Container */
        .pl-container {
            background: white;
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        /* P&L Header Section */
        .pl-header {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            border-bottom: 4px solid #2c3e50;
            padding: 25px 20px;
            text-align: center;
        }

        .pl-title {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .pl-subtitle {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* Controls Section */
        .pl-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .pl-control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pl-control-group label {
            font-weight: 600;
            color: #34495e;
            white-space: nowrap;
            font-size: 14px;
        }

        .pl-select {
            padding: 10px 14px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .pl-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }

        .pl-btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .pl-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .pl-btn-export {
            background: #27ae60;
        }

        .pl-btn-export:hover {
            background: #219a52;
        }

        .pl-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        /* Content Area */
        .pl-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: white;
        }

        .pl-table-wrapper {
            width: 100%;
            overflow: auto;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #ecf0f1;
            background: white;
        }

        .pl-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
            min-width: 1400px;
        }

        /* Table Header */
        .pl-table th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid #34495e;
            white-space: nowrap;
            line-height: 1.3;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .pl-table th:first-child {
            text-align: left;
            width: 350px;
            padding-left: 15px;
        }

        .pl-table th.amount-header {
            width: 120px;
            text-align: center;
        }

        /* Table Body */
        .pl-table td {
            padding: 8px 10px;
            border: 1px solid #ecf0f1;
            vertical-align: middle;
            background: white;
            line-height: 1.3;
        }

        .pl-table tbody tr:hover {
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        /* Category Headers */
        .pl-category-header {
            background: linear-gradient(135deg, #3498db, #2980b9) !important;
            color: white !important;
            font-weight: 700 !important;
            font-size: 13px !important;
            text-transform: uppercase !important;
        }

        .pl-category-header td {
            padding: 15px 10px !important;
            border: 1px solid #2980b9 !important;
            font-weight: 700 !important;
        }

        .pl-category-header:hover {
            background: linear-gradient(135deg, #3498db, #2980b9) !important;
            transform: none !important;
        }

        /* Data Rows */
        .pl-data-row {
            background: white !important;
        }

        .pl-data-row td {
            padding: 6px 10px !important;
            border: 1px solid #ecf0f1 !important;
            font-size: 12px !important;
        }

        .pl-data-row td:first-child {
            font-weight: 500;
            color: #2c3e50;
            text-align: left;
            padding-left: 25px !important;
        }

        /* Amount Cells */
        .amount-cell {
            text-align: right !important;
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-weight: 600 !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            padding-right: 15px !important;
        }

        .amount-positive {
            color: #27ae60 !important;
        }

        .amount-negative {
            color: #e74c3c !important;
        }

        .amount-zero {
            color: #95a5a6 !important;
            font-style: italic !important;
        }

        /* Total Rows */
        .pl-total-row {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
            font-weight: 700 !important;
            color: #856404 !important;
        }

        .pl-total-row td {
            padding: 10px !important;
            border: 2px solid #f39c12 !important;
            font-size: 13px !important;
            font-weight: 700 !important;
        }

        .pl-gross-profit-row {
            background: linear-gradient(135deg, #d4edda, #c3e6cb) !important;
            font-weight: 700 !important;
            color: #155724 !important;
            font-size: 14px !important;
        }

        .pl-gross-profit-row td {
            padding: 12px 10px !important;
            border: 3px solid #27ae60 !important;
            font-weight: 700 !important;
        }

        .pl-operating-profit-row {
            background: linear-gradient(135deg, #e2e3f0, #d1d3e8) !important;
            font-weight: 700 !important;
            color: #6c5ce7 !important;
            font-size: 14px !important;
        }

        .pl-operating-profit-row td {
            padding: 12px 10px !important;
            border: 3px solid #a29bfe !important;
            font-weight: 700 !important;
        }

        .pl-net-profit-row {
            background: linear-gradient(135deg, #d1f2eb, #a3e4d7) !important;
            font-weight: 700 !important;
            color: #00695c !important;
            font-size: 15px !important;
        }

        .pl-net-profit-row td {
            padding: 15px 10px !important;
            border: 3px solid #1abc9c !important;
            font-weight: 700 !important;
        }

        /* Percentage Rows */
        .pl-percentage-row {
            background: linear-gradient(135deg, #fff9c4, #f4f1bb) !important;
            font-weight: 600 !important;
            color: #bf9000 !important;
            font-style: italic !important;
        }

        .pl-percentage-row td {
            padding: 6px 10px !important;
            border: 1px solid #f39c12 !important;
            font-size: 11px !important;
        }

        /* Headcount Rows */
        .pl-headcount-header {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e) !important;
            font-weight: 700 !important;
            color: #e17055 !important;
            font-size: 13px !important;
        }

        .pl-headcount-header td {
            padding: 10px !important;
            border: 2px solid #fdcb6e !important;
            font-weight: 700 !important;
        }

        .pl-headcount-row {
            background: #fff8e1 !important;
        }

        .pl-headcount-row td {
            padding: 6px 10px !important;
            border: 1px solid #ffcc02 !important;
            font-size: 12px !important;
            text-align: center !important;
        }

        .pl-headcount-row td:first-child {
            text-align: left !important;
            padding-left: 25px !important;
        }

        /* Loading and Error States */
        .pl-loading, .pl-error {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #7f8c8d;
            min-height: 400px;
        }

        .pl-loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #ecf0f1;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pl-error-icon {
            font-size: 64px;
            color: #e74c3c;
            margin-bottom: 20px;
        }

        /* Status Bar */
        .pl-status-bar {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-top: 3px solid #3498db;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 500;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Print Styles */
        @media print {
            .header, .pl-controls, .pl-status-bar {
                display: none;
            }
            
            .pl-table {
                font-size: 10px;
            }
            
            .pl-table th, .pl-table td {
                padding: 4px 6px;
            }
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .pl-table {
                font-size: 11px;
            }
            
            .pl-table th {
                padding: 12px 8px;
                font-size: 10px;
            }
            
            .pl-table td {
                padding: 5px 8px;
            }
            
            .amount-cell {
                font-size: 11px !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .pl-title {
                font-size: 24px;
            }
            
            .pl-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .pl-table {
                font-size: 10px;
                min-width: 1200px;
            }
        }

        /* Animation for data updates */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pl-table tbody tr {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
        }

        /* Scroll indicator */
        .scroll-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            padding: 10px;
            border-radius: 50%;
            display: none;
            z-index: 1000;
            cursor: pointer;
        }

        .scroll-indicator.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <h1>MIS System - Profit & Loss Report</h1>
                </div>
                <div class="header-actions">
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Dashboard
                    </a>
                    <a href="general-ledger.html" class="btn btn-secondary">
                        <i class="fas fa-book"></i> General Ledger
                    </a>
                    <button class="btn btn-success" onclick="exportPLReport()" id="exportBtn">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" style="max-width: 100%; padding: 0;">
        <div class="pl-container">
            
            <!-- Header Section -->
            <div class="pl-header">
                <div class="pl-title">PROFIT & LOSS STATEMENT</div>
                <div class="pl-subtitle" id="plReportPeriod">For the Month Ended June 2025</div>
                
                <!-- Controls -->
                <div class="pl-controls">
                    <div class="pl-control-group">
                        <label for="plYear">
                            <i class="fas fa-calendar-alt"></i> Year:
                        </label>
                        <select id="plYear" class="pl-select">
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    
                    <div class="pl-control-group">
                        <label for="plMonth">
                            <i class="fas fa-calendar"></i> Month:
                        </label>
                        <select id="plMonth" class="pl-select">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6" selected>June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    
                    <div class="pl-control-group">
                        <button class="pl-btn" onclick="loadPLReport()" id="generateBtn">
                            <i class="fas fa-sync-alt"></i> Generate Report
                        </button>
                    </div>
                    
                    <div class="pl-control-group">
                        <button class="pl-btn pl-btn-export" onclick="exportPLReport()" id="exportBtn2">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>

                    <div class="pl-control-group">
                        <button class="pl-btn" onclick="printReport()" id="printBtn" style="background: #9b59b6;">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="pl-loading" id="plLoading">
                <div class="pl-loading-spinner"></div>
                <div style="font-size: 20px; font-weight: 600; margin-bottom: 10px;">Generating Profit & Loss Report...</div>
                <div style="font-size: 14px; color: #95a5a6;">Compiling financial data from general ledger</div>
            </div>

            <!-- Error State -->
            <div class="pl-error" id="plError">
                <i class="fas fa-exclamation-triangle pl-error-icon"></i>
                <div style="font-size: 20px; font-weight: 600; margin-bottom: 10px; color: #e74c3c;">Error Generating Report</div>
                <div style="font-size: 14px; margin-bottom: 20px;">Unable to load financial data. Please check your connection and try again.</div>
                <button class="pl-btn" onclick="loadPLReport()">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>

            <!-- Report Content -->
            <div class="pl-content" id="plContent" style="display: none;">
                <div class="pl-table-wrapper">
                    <table class="pl-table" id="plTable">
                        <thead>
                            <tr>
                                <th>PARTICULARS</th>
                                <th class="amount-header">ACTUAL<br><span id="plActualHeader" style="font-size: 9px;">JUN 2025</span></th>
                                <th class="amount-header">ACCUM SYSTEM<br><span id="plAccumHeader" style="font-size: 9px;">JAN-JUN 2025</span></th>
                                <th class="amount-header">LAST REPORT<br><span style="font-size: 9px;">MIS</span></th>
                                <th class="amount-header">BUDGET<br><span style="font-size: 9px;">PLANNED</span></th>
                                <th class="amount-header">VARIANCE<br><span style="font-size: 9px;">DIFF</span></th>
                                <th class="amount-header">LAST YEAR<br><span style="font-size: 9px;">COMPARISON</span></th>
                            </tr>
                        </thead>
                        <tbody id="plTableBody">
                            <!-- Data will be loaded here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="pl-status-bar">
                <span>
                    <i class="fas fa-info-circle"></i>
                    <span id="plStatusInfo">Ready to generate report</span>
                </span>
                <span>
                    <i class="fas fa-clock"></i>
                    Last Updated: <span id="plTimestamp">--</span>
                </span>
                <span>
                    <i class="fas fa-database"></i>
                    Data Source: General Ledger
                </span>
            </div>

        </div>
    </div>

    <!-- Scroll to Top Button -->
    <div class="scroll-indicator" id="scrollToTop" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </div>

    <!-- JavaScript Implementation -->
    <script>
        // =====================================================
        // COMPLETE P&L REPORT MANAGER - FULL IMPLEMENTATION
        // =====================================================
        
        class PLReportManager {
            constructor() {
                this.currentYear = new Date().getFullYear();
                this.currentMonth = new Date().getMonth() + 1;
                this.reportData = {};
                this.isLoading = false;
                this.retryCount = 0;
                this.maxRetries = 3;
                
                this.init();
            }
            
            init() {
                console.log('🚀 Initializing Complete P&L Report Manager...');
                this.bindEvents();
                this.setupScrollIndicator();
                this.setCurrentDate();
            }
            
            bindEvents() {
                // Year/Month change events
                document.getElementById('plYear').addEventListener('change', () => {
                    this.updateReportHeader();
                });
                
                document.getElementById('plMonth').addEventListener('change', () => {
                    this.updateReportHeader();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'r') {
                        e.preventDefault();
                        this.loadPLReport();
                    }
                    
                    if (e.ctrlKey && e.key === 'e') {
                        e.preventDefault();
                        this.exportToCSV();
                    }
                    
                    if (e.ctrlKey && e.key === 'p') {
                        e.preventDefault();
                        this.printReport();
                    }
                });
                
                console.log('✅ All events bound successfully');
            }
            
            setupScrollIndicator() {
                window.addEventListener('scroll', () => {
                    const scrollIndicator = document.getElementById('scrollToTop');
                    if (window.scrollY > 300) {
                        scrollIndicator.classList.add('show');
                    } else {
                        scrollIndicator.classList.remove('show');
                    }
                });
            }
            
            setCurrentDate() {
                const now = new Date();
                document.getElementById('plYear').value = now.getFullYear();
                document.getElementById('plMonth').value = now.getMonth() + 1;
                this.updateReportHeader();
            }
            
            updateReportHeader() {
                const year = document.getElementById('plYear').value;
                const month = document.getElementById('plMonth').value;
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                const monthName = monthNames[month - 1];
                const monthShort = monthName.substring(0, 3).toUpperCase();
                
                document.getElementById('plReportPeriod').textContent = 
                    `For the Month Ended ${monthName} ${year}`;
                document.getElementById('plActualHeader').textContent = `${monthShort} ${year}`;
                document.getElementById('plAccumHeader').textContent = `JAN-${monthShort} ${year}`;
            }
            
            async loadPLReport() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.showLoading(true);
                this.hideError();
                this.disableButtons(true);
                
                try {
                    const year = parseInt(document.getElementById('plYear').value);
                    const month = parseInt(document.getElementById('plMonth').value);
                    
                    console.log(`📊 Loading Complete P&L Report for ${year}-${month}...`);
                    this.updateStatusBar('Loading financial data...');
                    
                    const response = await fetch(`/api/reports/pl-complete/${year}/${month}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Failed to fetch P&L data');
                    }
                    
                    if (!result.data) {
                        throw new Error('No data returned from server');
                    }
                    
                    this.reportData = this.validateAndProcessData(result.data);
                    this.renderCompleteReport();
                    this.updateStatusBar(`Report generated successfully for ${this.getMonthName(month)} ${year}`);
                    
                    // Reset retry count on success
                    this.retryCount = 0;
                    
                    console.log('✅ P&L Report loaded successfully');
                    
                } catch (error) {
                    console.error('❌ Error loading P&L report:', error);
                    this.handleError(error);
                } finally {
                    this.isLoading = false;
                    this.showLoading(false);
                    this.disableButtons(false);
                }
            }
            
            validateAndProcessData(data) {
                const defaultAmounts = { actual: 0, cumulative: 0, previous: 0 };
                
                // Ensure all required fields exist with default values
                const processedData = {
                    // Revenue
                    revenue: data.revenue || defaultAmounts,
                    
                    // Direct Costs
                    directPayroll: data.directPayroll || defaultAmounts,
                    directExpenses: data.directExpenses || defaultAmounts,
                    materials: data.materials || defaultAmounts,
                    subcontractorCharges: data.subcontractorCharges || defaultAmounts,
                    transportationFuel: data.transportationFuel || defaultAmounts,
                    freightCustomDuty: data.freightCustomDuty || defaultAmounts,
                    provisionEmployees: data.provisionEmployees || defaultAmounts,
                    depreciation: data.depreciation || defaultAmounts,
                    otherDirectExpenses: data.otherDirectExpenses || defaultAmounts,
                    rentalLabors: data.rentalLabors || defaultAmounts,
                    workInProgress: data.workInProgress || defaultAmounts,
                    totalDirectCost: data.totalDirectCost || defaultAmounts,
                    grossProfit: data.grossProfit || defaultAmounts,
                    
                    // General & Administrative Expenses
                    indirectPayroll: data.indirectPayroll || defaultAmounts,
                    otherAdminExpenses: data.otherAdminExpenses || defaultAmounts,
                    employeesAllowances: data.employeesAllowances || defaultAmounts,
                    motorVehicle: data.motorVehicle || defaultAmounts,
                    professionalFees: data.professionalFees || defaultAmounts,
                    licensesVisaFees: data.licensesVisaFees || defaultAmounts,
                    rent: data.rent || defaultAmounts,
                    marketing: data.marketing || defaultAmounts,
                    insurance: data.insurance || defaultAmounts,
                    travelEntertainment: data.travelEntertainment || defaultAmounts,
                    telephone: data.telephone || defaultAmounts,
                    depreciationIndirect: data.depreciationIndirect || defaultAmounts,
                    printingStationery: data.printingStationery || defaultAmounts,
                    electricityWater: data.electricityWater || defaultAmounts,
                    officeSupplies: data.officeSupplies || defaultAmounts,
                    depreciationRightToUse: data.depreciationRightToUse || defaultAmounts,
                    repairsMaintenance: data.repairsMaintenance || defaultAmounts,
                    provisionEmployeesIndirect: data.provisionEmployeesIndirect || defaultAmounts,
                    otherGeneralAdmin: data.otherGeneralAdmin || defaultAmounts,
                    impairmentTradeReceivables: data.impairmentTradeReceivables || defaultAmounts,
                    impairmentRetentionReceivables: data.impairmentRetentionReceivables || defaultAmounts,
                    lossLiquidatedBankGuarantees: data.lossLiquidatedBankGuarantees || defaultAmounts,
                    totalGeneralAdmin: data.totalGeneralAdmin || defaultAmounts,
                    totalOperatingProfit: data.totalOperatingProfit || defaultAmounts,
                    
                    // Other Income/Expenses
                    borrowingsCosts: data.borrowingsCosts || defaultAmounts,
                    otherIncome: data.otherIncome || defaultAmounts,
                    netProfit: data.netProfit || defaultAmounts,
                    
                    // Headcount
                    directHeadcount: data.directHeadcount || defaultAmounts,
                    indirectHeadcount: data.indirectHeadcount || defaultAmounts,
                    totalHeadcount: data.totalHeadcount || defaultAmounts
                };
                
                return processedData;
            }
            
            renderCompleteReport() {
                console.log('🎨 Rendering Complete P&L Report...');
                
                const tbody = document.getElementById('plTableBody');
                let html = '';
                
                try {
                    // REVENUE Section
                    html += this.renderCategoryHeader('REVENUE');
                    html += this.renderDataRow('REVENUE', this.reportData.revenue);
                    
                    // DIRECT COST Section (No blank row between Revenue and Direct Payroll)
                    html += this.renderDataRow('Direct Payroll', this.reportData.directPayroll);
                    html += this.renderDataRow('Direct Expenses', this.reportData.directExpenses);
                    html += this.renderDataRow('Materials', this.reportData.materials);
                    html += this.renderDataRow('Subcontractor Charges', this.reportData.subcontractorCharges);
                    html += this.renderDataRow('Transportation & Fuel', this.reportData.transportationFuel);
                    html += this.renderDataRow('Freight and Custom Duty', this.reportData.freightCustomDuty);
                    html += this.renderDataRow('Prov for Employees End of Service Benefits-Direct', this.reportData.provisionEmployees);
                    html += this.renderDataRow('Dep on Property and Equipment (Projects)-Direct', this.reportData.depreciation);
                    html += this.renderDataRow('Other Direct Expenses', this.reportData.otherDirectExpenses);
                    html += this.renderDataRow('Rental Labors', this.reportData.rentalLabors);
                    html += this.renderDataRow('Work in Progress', this.reportData.workInProgress);
                    html += this.renderTotalRow('TOTAL DIRECT COST', this.reportData.totalDirectCost, 'pl-total-row');
                    
                    // GROSS PROFIT + GOP%
                    html += this.renderTotalRow('TOTAL GROSS PROFIT', this.reportData.grossProfit, 'pl-gross-profit-row');
                    html += this.renderPercentageRow('GOP%', this.calculateGOPPercentage());
                    
                    // GENERAL & ADMINISTRATIVE EXPENSES Section
                    html += this.renderCategoryHeader('GENERAL & ADMINISTRATIVE EXPENSES');
                    html += this.renderDataRow('Indirect Payroll', this.reportData.indirectPayroll);
                    html += this.renderDataRow('Other Administration Expenses', this.reportData.otherAdminExpenses);
                    html += this.renderDataRow('Employees Allowances (Leave Salaries,Accom,EOS,Car,Bonus)', this.reportData.employeesAllowances);
                    html += this.renderDataRow('Motor Vehicle Petrol and Maintenance', this.reportData.motorVehicle);
                    html += this.renderDataRow('Professional and Government Fees', this.reportData.professionalFees);
                    html += this.renderDataRow('Licenses and Visa Fees', this.reportData.licensesVisaFees);
                    html += this.renderDataRow('Rent', this.reportData.rent);
                    html += this.renderDataRow('Marketing (Clients Inquiries and Tender Costs)', this.reportData.marketing);
                    html += this.renderDataRow('Insurance', this.reportData.insurance);
                    html += this.renderDataRow('Travel & Entertainment (Tickets)', this.reportData.travelEntertainment);
                    html += this.renderDataRow('Telephone', this.reportData.telephone);
                    html += this.renderDataRow('Depreciation of Property and Equipment-Indirect', this.reportData.depreciationIndirect);
                    html += this.renderDataRow('Printing & Stationery', this.reportData.printingStationery);
                    html += this.renderDataRow('Electricity & Water', this.reportData.electricityWater);
                    html += this.renderDataRow('Office Supplies', this.reportData.officeSupplies);
                    html += this.renderDataRow('Depreciation of Right to use asset', this.reportData.depreciationRightToUse);
                    html += this.renderDataRow('Repairs & Maintenance & Uniforms & IT', this.reportData.repairsMaintenance);
                    html += this.renderDataRow('Prov for Employees End of Service Benefits-Indirect', this.reportData.provisionEmployeesIndirect);
                    html += this.renderDataRow('Other General & Admin Expenses', this.reportData.otherGeneralAdmin);
                    html += this.renderDataRow('Impairment of Trade Receivables', this.reportData.impairmentTradeReceivables);
                    html += this.renderDataRow('Impairment of Retention Receivables', this.reportData.impairmentRetentionReceivables);
                    html += this.renderDataRow('Loss on Liquidated Bank Guarantees', this.reportData.lossLiquidatedBankGuarantees);
                    html += this.renderTotalRow('TOTAL GENERAL & ADMINISTRATIVE EXPENSES', this.reportData.totalGeneralAdmin, 'pl-total-row');
                    
                    // OPERATING PROFIT
                    html += this.renderTotalRow('TOTAL OPERATING PROFIT', this.reportData.totalOperatingProfit, 'pl-operating-profit-row');
                    
                    // OTHER INCOME/EXPENSES
                    html += this.renderDataRow('Borrowings Costs', this.reportData.borrowingsCosts);
                    html += this.renderDataRow('Other Income', this.reportData.otherIncome);
                    
                    // NET PROFIT + NOP%
                    html += this.renderTotalRow('TOTAL NET PROFIT FOR THE YEAR', this.reportData.netProfit, 'pl-net-profit-row');
                    html += this.renderPercentageRow('NOP%', this.calculateNOPPercentage());
                    
                    // HEADCOUNT Section
                    html += this.renderHeadcountRow('Direct Headcount', this.reportData.directHeadcount);
                    html += this.renderHeadcountRow('Indirect Headcount', this.reportData.indirectHeadcount);
                    html += this.renderHeadcountTotalRow('Total Headcount', this.reportData.totalHeadcount);
                    
                    tbody.innerHTML = html;
                    document.getElementById('plContent').style.display = 'block';
                    
                    console.log('✅ Complete P&L Report rendered successfully');
                    
                } catch (renderError) {
                    console.error('❌ Error rendering report:', renderError);
                    this.handleError(renderError);
                }
            }
            
            renderCategoryHeader(title) {
                return `
                    <tr class="pl-category-header">
                        <td><strong>${title}</strong></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                `;
            }
            
            renderDataRow(description, amounts) {
                const actualAmount = amounts?.actual ?? 0;
                const cumulativeAmount = amounts?.cumulative ?? 0;
                const previousAmount = amounts?.previous ?? 0;
                
                return `
                    <tr class="pl-data-row">
                        <td>${description}</td>
                        <td class="amount-cell">${this.formatAmount(actualAmount)}</td>
                        <td class="amount-cell">${this.formatAmount(cumulativeAmount)}</td>
                        <td class="amount-cell">${this.formatAmount(previousAmount)}</td>
                        <td class="amount-cell">-</td>
                        <td class="amount-cell">-</td>
                        <td class="amount-cell">-</td>
                    </tr>
                `;
            }
            
            renderTotalRow(title, totals, cssClass) {
                const actualAmount = totals?.actual ?? 0;
                const cumulativeAmount = totals?.cumulative ?? 0;
                const previousAmount = totals?.previous ?? 0;
                
                return `
                    <tr class="${cssClass}">
                        <td><strong>${title}</strong></td>
                        <td class="amount-cell"><strong>${this.formatAmount(actualAmount)}</strong></td>
                        <td class="amount-cell"><strong>${this.formatAmount(cumulativeAmount)}</strong></td>
                        <td class="amount-cell"><strong>${this.formatAmount(previousAmount)}</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                    </tr>
                `;
            }
            
            renderPercentageRow(title, percentages) {
                const actualPercentage = percentages?.actual ?? 0;
                const cumulativePercentage = percentages?.cumulative ?? 0;
                const previousPercentage = percentages?.previous ?? 0;
                
                return `
                    <tr class="pl-percentage-row">
                        <td><strong>${title}</strong></td>
                        <td class="amount-cell"><strong>${this.formatPercentage(actualPercentage)}</strong></td>
                        <td class="amount-cell"><strong>${this.formatPercentage(cumulativePercentage)}</strong></td>
                        <td class="amount-cell"><strong>${this.formatPercentage(previousPercentage)}</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                    </tr>
                `;
            }
            
            renderHeadcountRow(description, counts) {
                const actualCount = counts?.actual ?? 0;
                const cumulativeCount = counts?.cumulative ?? 0;
                const previousCount = counts?.previous ?? 0;
                
                return `
                    <tr class="pl-headcount-row">
                        <td>${description}</td>
                        <td class="amount-cell">${actualCount}</td>
                        <td class="amount-cell">${cumulativeCount}</td>
                        <td class="amount-cell">${previousCount}</td>
                        <td class="amount-cell">-</td>
                        <td class="amount-cell">-</td>
                        <td class="amount-cell">-</td>
                    </tr>
                `;
            }
            
            renderHeadcountTotalRow(title, counts) {
                const actualCount = counts?.actual ?? 0;
                const cumulativeCount = counts?.cumulative ?? 0;
                const previousCount = counts?.previous ?? 0;
                
                return `
                    <tr class="pl-headcount-header">
                        <td><strong>${title}</strong></td>
                        <td class="amount-cell"><strong>${actualCount}</strong></td>
                        <td class="amount-cell"><strong>${cumulativeCount}</strong></td>
                        <td class="amount-cell"><strong>${previousCount}</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                        <td class="amount-cell"><strong>-</strong></td>
                    </tr>
                `;
            }
            
            calculateGOPPercentage() {
                const grossProfitActual = this.reportData.grossProfit?.actual ?? 0;
                const grossProfitCumulative = this.reportData.grossProfit?.cumulative ?? 0;
                const grossProfitPrevious = this.reportData.grossProfit?.previous ?? 0;
                
                const revenueActual = this.reportData.revenue?.actual ?? 0;
                const revenueCumulative = this.reportData.revenue?.cumulative ?? 0;
                const revenuePrevious = this.reportData.revenue?.previous ?? 0;
                
                return {
                    actual: revenueActual !== 0 ? Math.round((grossProfitActual / revenueActual) * 100) : 0,
                    cumulative: revenueCumulative !== 0 ? Math.round((grossProfitCumulative / revenueCumulative) * 100) : 0,
                    previous: revenuePrevious !== 0 ? Math.round((grossProfitPrevious / revenuePrevious) * 100) : 0
                };
            }
            
            calculateNOPPercentage() {
                const netProfitActual = this.reportData.netProfit?.actual ?? 0;
                const netProfitCumulative = this.reportData.netProfit?.cumulative ?? 0;
                const netProfitPrevious = this.reportData.netProfit?.previous ?? 0;
                
                const revenueActual = this.reportData.revenue?.actual ?? 0;
                const revenueCumulative = this.reportData.revenue?.cumulative ?? 0;
                const revenuePrevious = this.reportData.revenue?.previous ?? 0;
                
                return {
                    actual: revenueActual !== 0 ? Math.round((netProfitActual / revenueActual) * 100) : 0,
                    cumulative: revenueCumulative !== 0 ? Math.round((netProfitCumulative / revenueCumulative) * 100) : 0,
                    previous: revenuePrevious !== 0 ? Math.round((netProfitPrevious / revenuePrevious) * 100) : 0
                };
            }
            
            formatAmount(amount) {
                const numAmount = parseFloat(amount);
                if (isNaN(numAmount) || numAmount === 0) {
                    return '<span class="amount-zero">-</span>';
                }
                
                const formatted = Math.abs(numAmount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                const cssClass = numAmount > 0 ? 'amount-positive' : 'amount-negative';
                const display = numAmount < 0 ? `(${formatted})` : formatted;
                
                return `<span class="${cssClass}">${display}</span>`;
            }
            
            formatPercentage(percentage) {
                const numPercentage = parseFloat(percentage);
                if (isNaN(numPercentage)) {
                    return '<span class="amount-zero">0%</span>';
                }
                
                const cssClass = numPercentage > 0 ? 'amount-positive' : 'amount-negative';
                const display = numPercentage < 0 ? `(${Math.abs(numPercentage)}%)` : `${numPercentage}%`;
                
                return `<span class="${cssClass}">${display}</span>`;
            }
            
            async exportToCSV() {
                console.log('📁 Exporting Complete P&L Report to CSV...');
                
                if (!this.reportData || Object.keys(this.reportData).length === 0) {
                    this.showToast('No report data to export. Please generate a report first.', 'warning');
                    return;
                }
                
                try {
                    const year = document.getElementById('plYear').value;
                    const month = document.getElementById('plMonth').value;
                    const monthName = this.getMonthName(parseInt(month));
                    
                    let csvContent = `PROFIT & LOSS STATEMENT\n`;
                    csvContent += `For the Month Ended ${monthName} ${year}\n\n`;
                    csvContent += `Particulars,Actual,Accum System,Last Report MIS,Budget,Variance,Last Year\n`;
                    
                    // Add all sections to CSV
                    csvContent += `\nREVENUE\n`;
                    csvContent += `REVENUE,${this.reportData.revenue.actual},${this.reportData.revenue.cumulative},${this.reportData.revenue.previous},-,-,-\n`;
                    csvContent += `Direct Payroll,${this.reportData.directPayroll.actual},${this.reportData.directPayroll.cumulative},${this.reportData.directPayroll.previous},-,-,-\n`;
                    csvContent += `Direct Expenses,${this.reportData.directExpenses.actual},${this.reportData.directExpenses.cumulative},${this.reportData.directExpenses.previous},-,-,-\n`;
                    csvContent += `Materials,${this.reportData.materials.actual},${this.reportData.materials.cumulative},${this.reportData.materials.previous},-,-,-\n`;
                    csvContent += `Subcontractor Charges,${this.reportData.subcontractorCharges.actual},${this.reportData.subcontractorCharges.cumulative},${this.reportData.subcontractorCharges.previous},-,-,-\n`;
                    csvContent += `Transportation & Fuel,${this.reportData.transportationFuel.actual},${this.reportData.transportationFuel.cumulative},${this.reportData.transportationFuel.previous},-,-,-\n`;
                    csvContent += `Freight and Custom Duty,${this.reportData.freightCustomDuty.actual},${this.reportData.freightCustomDuty.cumulative},${this.reportData.freightCustomDuty.previous},-,-,-\n`;
                    csvContent += `Prov for Employees End of Service Benefits-Direct,${this.reportData.provisionEmployees.actual},${this.reportData.provisionEmployees.cumulative},${this.reportData.provisionEmployees.previous},-,-,-\n`;
                    csvContent += `Dep on Property and Equipment (Projects)-Direct,${this.reportData.depreciation.actual},${this.reportData.depreciation.cumulative},${this.reportData.depreciation.previous},-,-,-\n`;
                    csvContent += `Other Direct Expenses,${this.reportData.otherDirectExpenses.actual},${this.reportData.otherDirectExpenses.cumulative},${this.reportData.otherDirectExpenses.previous},-,-,-\n`;
                    csvContent += `Rental Labors,${this.reportData.rentalLabors.actual},${this.reportData.rentalLabors.cumulative},${this.reportData.rentalLabors.previous},-,-,-\n`;
                    csvContent += `Work in Progress,${this.reportData.workInProgress.actual},${this.reportData.workInProgress.cumulative},${this.reportData.workInProgress.previous},-,-,-\n`;
                    csvContent += `TOTAL DIRECT COST,${this.reportData.totalDirectCost.actual},${this.reportData.totalDirectCost.cumulative},${this.reportData.totalDirectCost.previous},-,-,-\n`;
                    csvContent += `TOTAL GROSS PROFIT,${this.reportData.grossProfit.actual},${this.reportData.grossProfit.cumulative},${this.reportData.grossProfit.previous},-,-,-\n`;
                    
                    const gopPercentage = this.calculateGOPPercentage();
                    csvContent += `GOP%,${gopPercentage.actual}%,${gopPercentage.cumulative}%,${gopPercentage.previous}%,-,-,-\n`;
                    
                    csvContent += `\nGENERAL & ADMINISTRATIVE EXPENSES\n`;
                    csvContent += `Indirect Payroll,${this.reportData.indirectPayroll.actual},${this.reportData.indirectPayroll.cumulative},${this.reportData.indirectPayroll.previous},-,-,-\n`;
                    csvContent += `Other Administration Expenses,${this.reportData.otherAdminExpenses.actual},${this.reportData.otherAdminExpenses.cumulative},${this.reportData.otherAdminExpenses.previous},-,-,-\n`;
                    csvContent += `Employees Allowances,${this.reportData.employeesAllowances.actual},${this.reportData.employeesAllowances.cumulative},${this.reportData.employeesAllowances.previous},-,-,-\n`;
                    csvContent += `Motor Vehicle Petrol and Maintenance,${this.reportData.motorVehicle.actual},${this.reportData.motorVehicle.cumulative},${this.reportData.motorVehicle.previous},-,-,-\n`;
                    csvContent += `Professional and Government Fees,${this.reportData.professionalFees.actual},${this.reportData.professionalFees.cumulative},${this.reportData.professionalFees.previous},-,-,-\n`;
                    csvContent += `Licenses and Visa Fees,${this.reportData.licensesVisaFees.actual},${this.reportData.licensesVisaFees.cumulative},${this.reportData.licensesVisaFees.previous},-,-,-\n`;
                    csvContent += `Rent,${this.reportData.rent.actual},${this.reportData.rent.cumulative},${this.reportData.rent.previous},-,-,-\n`;
                    csvContent += `Marketing,${this.reportData.marketing.actual},${this.reportData.marketing.cumulative},${this.reportData.marketing.previous},-,-,-\n`;
                    csvContent += `Insurance,${this.reportData.insurance.actual},${this.reportData.insurance.cumulative},${this.reportData.insurance.previous},-,-,-\n`;
                    csvContent += `Travel & Entertainment,${this.reportData.travelEntertainment.actual},${this.reportData.travelEntertainment.cumulative},${this.reportData.travelEntertainment.previous},-,-,-\n`;
                    csvContent += `Telephone,${this.reportData.telephone.actual},${this.reportData.telephone.cumulative},${this.reportData.telephone.previous},-,-,-\n`;
                    csvContent += `Depreciation Indirect,${this.reportData.depreciationIndirect.actual},${this.reportData.depreciationIndirect.cumulative},${this.reportData.depreciationIndirect.previous},-,-,-\n`;
                    csvContent += `Printing & Stationery,${this.reportData.printingStationery.actual},${this.reportData.printingStationery.cumulative},${this.reportData.printingStationery.previous},-,-,-\n`;
                    csvContent += `Electricity & Water,${this.reportData.electricityWater.actual},${this.reportData.electricityWater.cumulative},${this.reportData.electricityWater.previous},-,-,-\n`;
                    csvContent += `Office Supplies,${this.reportData.officeSupplies.actual},${this.reportData.officeSupplies.cumulative},${this.reportData.officeSupplies.previous},-,-,-\n`;
                    csvContent += `Depreciation Right to Use,${this.reportData.depreciationRightToUse.actual},${this.reportData.depreciationRightToUse.cumulative},${this.reportData.depreciationRightToUse.previous},-,-,-\n`;
                    csvContent += `Repairs & Maintenance,${this.reportData.repairsMaintenance.actual},${this.reportData.repairsMaintenance.cumulative},${this.reportData.repairsMaintenance.previous},-,-,-\n`;
                    csvContent += `Provision Employees Indirect,${this.reportData.provisionEmployeesIndirect.actual},${this.reportData.provisionEmployeesIndirect.cumulative},${this.reportData.provisionEmployeesIndirect.previous},-,-,-\n`;
                    csvContent += `Other General Admin,${this.reportData.otherGeneralAdmin.actual},${this.reportData.otherGeneralAdmin.cumulative},${this.reportData.otherGeneralAdmin.previous},-,-,-\n`;
                    csvContent += `Impairment Trade Receivables,${this.reportData.impairmentTradeReceivables.actual},${this.reportData.impairmentTradeReceivables.cumulative},${this.reportData.impairmentTradeReceivables.previous},-,-,-\n`;
                    csvContent += `Impairment Retention Receivables,${this.reportData.impairmentRetentionReceivables.actual},${this.reportData.impairmentRetentionReceivables.cumulative},${this.reportData.impairmentRetentionReceivables.previous},-,-,-\n`;
                    csvContent += `Loss on Bank Guarantees,${this.reportData.lossLiquidatedBankGuarantees.actual},${this.reportData.lossLiquidatedBankGuarantees.cumulative},${this.reportData.lossLiquidatedBankGuarantees.previous},-,-,-\n`;
                    csvContent += `TOTAL GENERAL & ADMIN EXPENSES,${this.reportData.totalGeneralAdmin.actual},${this.reportData.totalGeneralAdmin.cumulative},${this.reportData.totalGeneralAdmin.previous},-,-,-\n`;
                    csvContent += `TOTAL OPERATING PROFIT,${this.reportData.totalOperatingProfit.actual},${this.reportData.totalOperatingProfit.cumulative},${this.reportData.totalOperatingProfit.previous},-,-,-\n`;
                    csvContent += `Borrowings Costs,${this.reportData.borrowingsCosts.actual},${this.reportData.borrowingsCosts.cumulative},${this.reportData.borrowingsCosts.previous},-,-,-\n`;
                    csvContent += `Other Income,${this.reportData.otherIncome.actual},${this.reportData.otherIncome.cumulative},${this.reportData.otherIncome.previous},-,-,-\n`;
                    csvContent += `TOTAL NET PROFIT FOR THE YEAR,${this.reportData.netProfit.actual},${this.reportData.netProfit.cumulative},${this.reportData.netProfit.previous},-,-,-\n`;
                    
                    const nopPercentage = this.calculateNOPPercentage();
                    csvContent += `NOP%,${nopPercentage.actual}%,${nopPercentage.cumulative}%,${nopPercentage.previous}%,-,-,-\n`;
                    
                    csvContent += `Direct Headcount,${this.reportData.directHeadcount.actual},${this.reportData.directHeadcount.cumulative},${this.reportData.directHeadcount.previous},-,-,-\n`;
                    csvContent += `Indirect Headcount,${this.reportData.indirectHeadcount.actual},${this.reportData.indirectHeadcount.cumulative},${this.reportData.indirectHeadcount.previous},-,-,-\n`;
                    csvContent += `Total Headcount,${this.reportData.totalHeadcount.actual},${this.reportData.totalHeadcount.cumulative},${this.reportData.totalHeadcount.previous},-,-,-\n`;
                    
                    const filename = `PL_Report_Complete_${monthName}_${year}.csv`;
                    this.downloadFile(csvContent, filename, 'text/csv');
                    
                    this.showToast('Report exported successfully!', 'success');
                    console.log('✅ CSV export completed');
                    
                } catch (error) {
                    console.error('❌ Export error:', error);
                    this.showToast('Export failed. Please try again.', 'error');
                }
            }
            
            printReport() {
                console.log('🖨️ Printing P&L Report...');
                window.print();
            }
            
            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
            
            handleError(error) {
                this.retryCount++;
                
                if (this.retryCount <= this.maxRetries) {
                    this.updateStatusBar(`Error occurred. Retry ${this.retryCount}/${this.maxRetries}: ${error.message}`);
                    setTimeout(() => {
                        this.loadPLReport();
                    }, 2000);
                } else {
                    this.showError();
                    this.updateStatusBar(`Failed to load report after ${this.maxRetries} attempts: ${error.message}`);
                    this.showToast('Failed to load P&L report. Please check your connection and try again.', 'error');
                }
            }
            
            showLoading(show) {
                document.getElementById('plLoading').style.display = show ? 'flex' : 'none';
                document.getElementById('plContent').style.display = show ? 'none' : 'block';
            }
            
            showError() {
                document.getElementById('plError').style.display = 'flex';
                document.getElementById('plContent').style.display = 'none';
            }
            
            hideError() {
                document.getElementById('plError').style.display = 'none';
            }
            
            disableButtons(disable) {
                const buttons = ['generateBtn', 'exportBtn', 'exportBtn2', 'printBtn'];
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.disabled = disable;
                        if (disable) {
                            btn.style.opacity = '0.6';
                        } else {
                            btn.style.opacity = '1';
                        }
                    }
                });
            }
            
            updateStatusBar(message) {
                document.getElementById('plStatusInfo').textContent = message;
                document.getElementById('plTimestamp').textContent = new Date().toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            showToast(message, type = 'info') {
                // Create toast if it doesn't exist
                let toast = document.getElementById('toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'toast';
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 12px 24px;
                        border-radius: 8px;
                        color: white;
                        font-weight: 600;
                        z-index: 10000;
                        display: none;
                        max-width: 400px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    `;
                    document.body.appendChild(toast);
                }
                
                // Set toast style based on type
                const styles = {
                    success: 'background: #27ae60;',
                    error: 'background: #e74c3c;',
                    warning: 'background: #f39c12;',
                    info: 'background: #3498db;'
                };
                
                toast.style.cssText += styles[type] || styles.info;
                toast.textContent = message;
                toast.style.display = 'block';
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 5000);
            }
            
            getMonthName(monthNumber) {
                const months = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                return months[monthNumber - 1] || 'Unknown';
            }
        }

        // =====================================================
        // GLOBAL FUNCTIONS AND EVENT HANDLERS
        // =====================================================
        
        let plManager;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing Complete P&L Report Manager...');
            
            // Initialize the manager
            plManager = new PLReportManager();
            
            // Auto-load report after initialization
            setTimeout(() => {
                loadPLReport();
            }, 1000);
        });

        // Global functions for HTML onclick events
        function loadPLReport() {
            if (plManager) {
                plManager.loadPLReport();
            } else {
                console.error('❌ PLManager not initialized');
            }
        }

        function exportPLReport() {
            if (plManager) {
                plManager.exportToCSV();
            } else {
                console.error('❌ PLManager not initialized');
            }
        }

        function printReport() {
            if (plManager) {
                plManager.printReport();
            } else {
                console.error('❌ PLManager not initialized');
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // =====================================================
        // ADDITIONAL UTILITY FUNCTIONS
        // =====================================================
        
        // Auto-refresh functionality (optional)
        function enableAutoRefresh(intervalMinutes = 5) {
            setInterval(() => {
                if (plManager && !plManager.isLoading) {
                    console.log('🔄 Auto-refreshing P&L report...');
                    plManager.loadPLReport();
                }
            }, intervalMinutes * 60 * 1000);
        }

        // Export to different formats
        function exportToPDF() {
            plManager.showToast('PDF export feature coming soon!', 'info');
        }

        function exportToExcel() {
            plManager.showToast('Excel export feature coming soon!', 'info');
        }

        // Data validation helper
        function validateReportData(data) {
            const requiredFields = ['revenue', 'grossProfit', 'netProfit'];
            return requiredFields.every(field => data.hasOwnProperty(field));
        }

        // Performance monitoring
        function logPerformance(startTime, operation) {
            const endTime = performance.now();
            const duration = (endTime - startTime).toFixed(2);
            console.log(`⏱️ ${operation} completed in ${duration}ms`);
        }

        // Network status monitoring
        window.addEventListener('online', () => {
            console.log('🌐 Network connection restored');
            if (plManager) {
                plManager.showToast('Network connection restored', 'success');
            }
        });

        window.addEventListener('offline', () => {
            console.log('🌐 Network connection lost');
            if (plManager) {
                plManager.showToast('Network connection lost. Report may not load properly.', 'warning');
            }
        });

        // Browser compatibility check
        function checkBrowserCompatibility() {
            const isCompatible = 
                'fetch' in window &&
                'Promise' in window &&
                'classList' in document.documentElement;
                
            if (!isCompatible) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h2>Browser Not Supported</h2>
                        <p>Please use a modern browser (Chrome, Firefox, Safari, Edge) to view this report.</p>
                    </div>
                `;
                return false;
            }
            return true;
        }

        // Initialize browser compatibility check
        if (!checkBrowserCompatibility()) {
            console.error('❌ Browser not compatible');
        }

        // Service Worker registration (for offline support)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('✅ Service Worker registered successfully:', registration);
                })
                .catch(error => {
                    console.log('ℹ️ Service Worker registration failed:', error);
                });
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && plManager) {
                // Refresh data when page becomes visible again
                const lastUpdate = localStorage.getItem('plLastUpdate');
                const now = Date.now();
                const fiveMinutes = 5 * 60 * 1000;
                
                if (!lastUpdate || (now - parseInt(lastUpdate)) > fiveMinutes) {
                    console.log('🔄 Page became visible, refreshing data...');
                    setTimeout(() => {
                        plManager.loadPLReport();
                    }, 1000);
                }
            }
        });

        // Save last update timestamp
        function saveLastUpdateTime() {
            localStorage.setItem('plLastUpdate', Date.now().toString());
        }

        // Memory cleanup
        window.addEventListener('beforeunload', () => {
            if (plManager) {
                // Clean up any ongoing operations
                plManager.isLoading = false;
            }
        });

        // Error boundary for uncaught errors
        window.addEventListener('error', (event) => {
            console.error('❌ Uncaught error:', event.error);
            if (plManager) {
                plManager.showToast('An unexpected error occurred. Please refresh the page.', 'error');
            }
        });

        // Promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            console.error('❌ Unhandled promise rejection:', event.reason);
            if (plManager) {
                plManager.showToast('A network error occurred. Please try again.', 'error');
            }
        });

        console.log('✅ Complete P&L Report Frontend loaded successfully');
        console.log('🎯 Features: Auto-refresh, Export, Print, Error handling, Responsive design');
        console.log('⚡ Ready for production use');
    </script>
</body>
</html>